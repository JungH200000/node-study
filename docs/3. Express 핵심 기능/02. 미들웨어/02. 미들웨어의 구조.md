## 🔬 미들웨어의 구조 파헤치기: 파라미터의 비밀

지난 글에서 우리는 라우트 핸들러 함수가 미들웨어의 한 종류라는 것을 배웠습니다. 모든 미들웨어는 **함수** 형태이며, Express가 실행할 수 있도록 라우트 메서드 등에 **인자(argument)** 로 전달됩니다. 이렇게 나중에 실행되도록 전달하는 함수를 **콜백 함수(Callback Function)** 라고 부릅니다.

Express는 이 콜백 함수를 실행할 때, 정해진 규칙에 따라 여러 유용한 '도구'들을 파라미터로 넣어줍니다. 미들웨어 함수가 몇 개의 파라미터를 갖도록 정의했는지에 따라 Express가 넣어주는 '도구'의 종류가 달라집니다.

미들웨어는 **2개, 3개, 또는 4개**의 파라미터를 가질 수 있습니다. 각각 어떤 역할을 하는지 코드를 통해 가볍게 알아보겠습니다.
자세한 사용법은 나중에 학습할 예정입니다.

---

### 1\. 파라미터 2개: `(req, res)` - 기본 요청 핸들러

가장 기본적이고 가장 많이 사용되는 형태의 미들웨어입니다.

- `req` (**Request**): 클라이언트의 **요청**에 대한 모든 정보가 담긴 객체입니다.
- `res` (**Response**): 클라이언트에게 보낼 **응답**을 만들 때 사용하는 객체입니다.

```javascript
// src/app.js
import express from 'express';

const app = express();
const PORT = 3000;

function greeting(req, res) {
  // req 객체에는 어떤 정보가 담겨있을까요?
  // 터미널에서 확인해 봅시다.
  console.log(req);
  res.json({ message: '안녕하세요, 반가워요!' });
}

app.get('/hello', greeting);

app.listen(PORT, () => {
  console.log(`🚀 Server started on port ${PORT}`);
});
```

`req` 객체 안에는 요청 URL, HTTP 메서드, 헤더, 쿼리 스트링 등 방대한 정보가 들어있습니다. 마찬가지로 `res` 객체에는 응답을 보내는 `.json()`, `.send()` 같은 유용한 메서드들이 포함되어 있습니다.

> **💡 모든 것을 외울 필요는 없어요\!** > `req`와 `res` 객체의 모든 속성을 외울 필요는 없습니다. `req.params`, `req.query`, `req.body`처럼 자주 사용하는 몇 가지만 익숙해지면 충분합니다. 더 자세한 내용이 궁금할 땐 언제든지 [Express 공식 문서 - Request Properties](https://expressjs.com/ko/api.html#req)를 참고하는 습관을 들이는 것이 좋습니다.

---

### 2\. 파라미터 3개: `(req, res, next)` - 다음으로 넘기기

세 번째 파라미터로 `next` 함수가 추가된 형태입니다.

- `next`: 현재 미들웨어의 역할을 다 마친 뒤, **다음 미들웨어로 제어권을 넘기는** 함수입니다.

하나의 요청은 여러 개의 미들웨어를 연달아 거칠 수 있습니다. 이때 `next()` 함수를 호출하면 Express는 현재 요청을 다음 미들웨어 함수에게 전달합니다.

```javascript
// src/app.js
// (Express, app, PORT 설정은 위와 동일)

function greeting(req, res, next) {
  console.log('첫 번째 미들웨어입니다!');
  // res.json(...)처럼 응답을 보내지 않고,
  // next()를 호출하면 다음 미들웨어로 넘어갑니다.
  next();
}

function sayHello(req, res) {
  console.log('두 번째 미들웨어입니다!');
  res.json({ message: '안녕하세요, 반가워요!' });
}

// '/hello' 경로에 두 개의 미들웨어를 배열로 연결했습니다.
app.get('/hello', [greeting, sayHello]);

// (app.listen 코드는 위와 동일)
```

위 예제처럼 `next()`는 하나의 요청에 대해 여러 단계의 처리가 필요할 때 사용됩니다. (자세한 활용법은 나중에 다룰 예정입니다.)

---

### 3\. 파라미터 4개: `(err, req, res, next)` - 오류 처리 전담

파라미터가 4개인 경우는 아주 특별한 목적을 가집니다. 바로 **오류 처리(Error Handling)** 입니다.

- `err`: 다른 미들웨어에서 발생한 **오류** 정보가 담기는 객체입니다.

이 미들웨어는 일반적인 요청 흐름에서는 실행되지 않습니다. 다른 미들웨어에서 오류가 발생했을 때(`throw` 사용) 또는 `next()` 함수에 인자(`next(error)`)를 전달했을 때만 실행되는 '오류 처리 전담팀'과 같습니다. 첫 번째 파라미터로 `err`가 온다는 점과 그 순서가 매우 중요합니다.

```javascript
// src/app.js
// (Express, app, PORT 설정은 위와 동일)

// 다른 미들웨어들...

// 오류 처리 미들웨어는 보통 서버 코드의 가장 마지막에 정의합니다.
function errorHandler(err, req, res, next) {
  console.error(err); // 발생한 에러를 콘솔에 출력
  res.status(500).json({ message: '서버 내부에서 오류가 발생했습니다.' });
}

// (app.listen 코드는 위와 동일)
```

오류 처리 미들웨어(Error Handler)에 대해서도 나중에 더 자세히 학습할 예정이니, 지금은 "아, 파라미터 4개짜리는 에러를 처리하는 특별한 미들웨어구나\!" 정도로만 기억해 주세요.
