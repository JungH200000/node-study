## 🔀 미들웨어 사용법 II: `app.all`과 `app.use` 활용하기

Express에서는 HTTP 메서드, 경로, 그리고 미들웨어(요청 핸들러)를 조합하여 하나의 API 엔드포인트를 만듭니다. 그런데 개발을 하다 보면, **여러 HTTP 메서드** 또는 **여러 경로**에 걸쳐 공통된 로직을 적용해야 할 때가 있습니다.

예를 들어, 특정 경로(`/hello`)에 대해 `GET`, `POST`, `DELETE` 요청 모두 동일한 응답을 보내야 한다면 어떻게 해야 할까요? 아래처럼 코드를 중복해서 작성하는 것은 좋은 방법이 아닐 겁니다.

```javascript
// 이렇게 작성하면 유지보수가 어려워집니다.
app.get('/hello', greeting);
app.post('/hello', greeting);
app.delete('/hello', greeting);
```

이럴 때 사용할 수 있는 Express의 강력한 메서드, `app.all()`과 `app.use()`에 대해 알아보겠습니다.

---

### 1\. `app.all()`: 모든 HTTP 메서드에 대응하기

`app.all()` 메서드는 이름 그대로, 특정 경로에 대해 **모든(all) HTTP 메서드**(`GET`, `POST`, `PUT`, `DELETE` 등)의 요청을 동일한 미들웨어로 처리하고 싶을 때 사용합니다.

```javascript
// src/app.js
import express from 'express';

const app = express();
const PORT = 3000;

function greeting(req, res, next) {
  // req.method를 통해 어떤 HTTP 메서드로 요청이 왔는지 확인할 수 있습니다.
  console.log(`'${req.method}' 메서드 요청을 받았습니다.`);
  res.json({ message: '안녕하세요, 반가워요!' });
}

// '/hello' 경로에 대한 모든 HTTP 메서드 요청을 greeting 미들웨어가 처리합니다.
app.all('/hello', greeting);

app.listen(PORT, () => {
  console.log(`🚀 Server started on port ${PORT}`);
});
```

이제 `GET`과 `POST` 메서드로 각각 요청을 보내 테스트해 봅시다.

```http
### GET 요청 테스트
GET http://localhost:3000/hello

### POST 요청 테스트
POST http://localhost:3000/hello
```

두 요청 모두 동일한 JSON 응답을 반환하는 것을 확인할 수 있습니다. `app.all()` 덕분에 코드를 중복해서 작성할 필요가 없어졌습니다.

#### `app.all()`과 다른 미들웨어 조합하기

`app.all()`은 다른 라우트 메서드와 함께 사용하여 '공통 처리' 미들웨어로 활용할 수도 있습니다. 예를 들어, `/hello` 경로로 들어오는 모든 요청에 대해 공통된 작업을 먼저 수행하고, 그 후에 각 HTTP 메서드에 맞는 개별 작업을 처리하는 식입니다.

```javascript
// src/app.js
import express from 'express';

const app = express();
const PORT = 3000;

// 1. '/hello' 경로의 모든 요청에 대해 가장 먼저 실행될 미들웨어
app.all('/hello', (req, res, next) => {
  console.log('[ALL] /hello 경로에 대한 공통 처리');
  next(); // 다음 미들웨어로 제어권을 넘김
});

// 2. GET 요청일 때만 실행될 미들웨어
app.get('/hello', (req, res, next) => {
  console.log('[GET] /hello 경로에 대한 GET 처리');
  res.json({ message: '안녕하세요, GET 요청 환영합니다!' });
});

// 3. POST 요청일 때만 실행될 미들웨어
app.post('/hello', (req, res, next) => {
  console.log('[POST] /hello 경로에 대한 POST 처리');
  res.json({ message: '안녕하세요, POST 요청 환영합니다!' });
});

app.listen(PORT, () => {
  console.log(`🚀 Server started on port ${PORT}`);
});
```

`GET http://localhost:3000/hello`로 요청을 보내면 터미널에는 다음과 같이 출력됩니다.

```bash
[ALL] /hello 경로에 대한 공통 처리
[GET] /hello 경로에 대한 GET 처리
```

`POST` 요청을 보내면 `[POST]` 미들웨어가 실행됩니다. 이처럼 `app.all()`은 특정 경로에 대한 '공통 선행 작업'을 정의하는 데 매우 유용합니다.

---

### 2\. `app.use()`: 특정 경로로 '시작'하는 모든 요청에 대응하기

`app.use()`도 `app.all()`처럼 모든 HTTP 메서드에 대해 미들웨어를 실행시킨다는 점에서는 비슷하지만, **경로를 다루는 방식**에서 결정적인 차이가 있습니다.

- `app.all('/hello', ...)`: **정확히** `/hello` 경로와 일치하는 요청에만 반응합니다.
- `app.use('/hello', ...)`: `/hello`로 **시작하는 모든 하위 경로** (예: `/hello/world`, `/hello/all/users`)의 요청에 반응합니다.

코드를 통해 직접 확인해 봅시다.

```javascript
// src/app.js
import express from 'express';

const app = express();
const PORT = 3000;

// '/hello'로 시작하는 모든 요청에 대해 실행될 미들웨어
app.use('/hello', (req, res, next) => {
  console.log("['/hello' USE] 이 경로는 /hello로 시작합니다!");
  next();
});

// 정확히 '/hello/all' 경로 + 모든 메서드에 대해 실행
app.all('/hello/all', (req, res, next) => {
  console.log("['/hello/all' ALL] 공통 처리");
  next();
});

// 정확히 '/hello/all' 경로 + GET 메서드에 대해 실행
app.get('/hello/all', (req, res, next) => {
  console.log("['/hello/all' GET] GET 요청 처리");
  res.json({ message: '안녕하세요, /hello/all GET!' });
});

// '/hello/world' 경로에 대한 라우트 추가
app.get('/hello/world', (req, res, next) => {
  console.log("['/hello/world' GET] GET 요청 처리");
  res.send({ message: '안녕, World!' });
});

app.listen(PORT, () => {
  console.log(`🚀 Server started on port ${PORT}`);
});
```

이제 두 가지 다른 경로로 요청을 보내보겠습니다.

1.  **`GET http://localhost:3000/hello/all`** 요청 시 터미널 출력:

    ```bash
    ['/hello' USE] 이 경로는 /hello로 시작합니다!
    ['/hello/all' ALL] 공통 처리
    ['/hello/all' GET] GET 요청 처리
    ```

    `/hello`로 시작하므로 `use` 미들웨어가 실행되고, 경로와 메서드가 일치하는 `all`과 `get` 미들웨어도 순차적으로 실행됩니다.

2.  **`GET http://localhost:3000/hello/world`** 요청 시 터미널 출력:

    ```bash
    ['/hello' USE] 이 경로는 /hello로 시작합니다!
    ['/hello/world' GET] GET 요청 처리
    ```

    이 경로 또한 `/hello`로 시작하므로 `use` 미들웨어는 실행되지만, `all('/hello/all')`과는 경로가 일치하지 않아 해당 미들웨어는 건너뛰게 됩니다.

#### 경로를 생략한 `app.use()`

만약 `app.use()`에 경로를 전달하지 않으면, 서버로 들어오는 **모든 요청**에 대해 해당 미들웨어를 실행합니다. 이는 로깅(logging), 요청 본문 파싱(body parsing) 등 모든 API에 전역적으로 적용되어야 하는 기능을 설정할 때 매우 유용하게 사용됩니다.

```javascript
// 이 미들웨어는 모든 요청에 대해 실행됩니다.
app.use((req, res, next) => {
  console.log('모든 요청에 대한 로깅 미들웨어');
  next();
});
```
