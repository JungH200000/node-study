## ⛓️ 미들웨어 사용법 I: 함수를 체인처럼 연결하기

지난 글에서 우리는 미들웨어 함수가 `req`, `res`, `next` 세 가지 파라미터를 받을 수 있다는 것을 배웠습니다. 이번에는 이 `next()` 함수를 활용하여 하나의 요청이 여러 미들웨어를 순차적으로 거치도록 만드는 방법을 자세히 알아보겠습니다.

### 미들웨어 체인(Middleware Chain)의 개념

`next`는 현재 미들웨어의 처리가 끝났음을 알리고 제어권을 **다음 미들웨어**로 넘기는 중요한 함수입니다. Express는 공식 문서에서 라우트 메서드의 구조를 다음과 같이 설명합니다.

`app.METHOD(path, callback[, callback, ...])`

- `path`: 라우트 경로 (예: `'/hello'`)
- `callback`: 실행될 미들웨어 함수
- `[, callback, ...]` : 대괄호(`[]`)는 이 부분이 **선택적(optional, 생략 가능)** 임을 의미합니다. 즉, 콜백 함수를 하나 이상 전달하여 여러 미들웨어를 체인처럼 연결할 수 있다는 뜻입니다.

하나의 요청은 이렇게 연결된 미들웨어들을 순서대로 통과하게 됩니다.

---

### 하나의 라우트에 여러 미들웨어 연결하기

이제 실제 코드를 통해 미들웨어를 연결해 보겠습니다. 기존의 `/hello` 라우트에 새로운 미들웨어를 추가해 봅시다.

```javascript
// src/app.js
import express from 'express';

const app = express();
const PORT = 3000;

// 미들웨어 1: 요청이 들어오면 가장 먼저 실행됩니다.
function meeting(req, res, next) {
  console.log('오');
  next(); // 처리가 끝났으니 다음 미들웨어로 넘깁니다.
}

// 미들웨어 2: meeting 미들웨어의 next()가 호출되면 실행됩니다.
function greeting(req, res, next) {
  console.log('안녕');
  // 여기서 응답을 보내고 체인을 종료합니다.
  res.json({ message: '안녕하세요, 반가워요!' });
}

// '/hello' 경로에 meeting과 greeting 미들웨어를 순서대로 연결합니다.
app.get('/hello', meeting, greeting);

app.listen(PORT, () => {
  console.log(`🚀 Server started on port ${PORT}`);
});
```

`app.get('/hello', ...)`에 `meeting`과 `greeting` 함수를 차례대로 전달했습니다. `meeting` 함수는 콘솔에 '오'를 출력한 뒤 `next()`를 호출하여 제어권을 `greeting` 함수로 넘겨줍니다.

이제 이 라우트로 GET 요청을 보내면, 클라이언트는 `greeting` 함수가 보낸 JSON 응답을 정상적으로 받게 되고, 서버 터미널에는 두 미들웨어의 콘솔 메시지가 순서대로 출력됩니다.

```bash
오
안녕
```

---

### 미들웨어의 실행 순서는 어떻게 결정될까?

여기서 한 가지 궁금한 점은 '다음 미들웨어가 되는 기준은 무엇일까?'입니다.

결론부터 말하면, **라우트 메서드에 인자로 전달하는 순서**가 바로 미들웨어의 실행 순서입니다. Express는 `app.get()`에 전달된 함수들을 순서대로 기억해 두었다가, `next()`가 호출될 때마다 다음 순서의 함수를 실행시켜 줍니다.

미들웨어를 하나 더 추가해서 확인해 볼까요?

```javascript
// src/app.js
import express from 'express';

const app = express();
const PORT = 3000;

function meeting(req, res, next) {
  console.log('오');
  next();
}

function waving(req, res, next) {
  console.log('(손을 흔든다.)');
  next();
}

function greeting(req, res, next) {
  console.log('안녕');
  res.json({ message: '안녕하세요, 반가워요!' });
}

// meeting -> waving -> greeting 순서로 미들웨어를 연결합니다.
app.get('/hello', meeting, waving, greeting);

app.listen(PORT, () => {
  console.log(`🚀 Server started on port ${PORT}`);
});
```

다시 `/hello`로 요청을 보내면, 터미널에는 우리가 인자로 전달한 순서 그대로 로그가 출력되는 것을 볼 수 있습니다.

```bash
오
(손을 흔든다.)
안녕
```

만약 `app.get('/hello', waving, meeting, greeting);` 처럼 인자의 순서를 바꾸면, 서버에 출력되는 로그의 순서도 `(손을 흔든다.)` -\> `오` -\> `안녕`으로 변경됩니다.

> **⚠️ 미들웨어의 순서는 매우 중요합니다.**
> 어떤 미들웨어가 먼저 실행되느냐에 따라 전체 애플리케이션의 동작이 달라질 수 있습니다. 예를 들어, '사용자 인증 미들웨어'는 '데이터 처리 미들웨어'보다 반드시 먼저 실행되어야 합니다. 따라서 미들웨어를 작성할 때는 실행 순서를 신중하게 고려해야 합니다.
