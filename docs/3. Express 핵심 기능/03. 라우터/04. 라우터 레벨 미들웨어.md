## 👮‍♀️ 라우터 레벨 미들웨어: 특정 경로 그룹에만 규칙 적용하기

우리는 이전에 `app.use()`를 사용해 애플리케이션 전체에 적용되는 **애플리케이션 레벨 미들웨어**를 만들어 보았습니다. 마치 도시 전체에 적용되는 규칙(예: "모든 방문객은 방문 기록을 남겨야 한다")과 같았죠.

하지만 때로는 특정 그룹의 라우트에만 적용되는 별도의 규칙이 필요합니다. 예를 들어, '상품 관리' API 그룹에 접근할 때는 특별한 인증을 거치도록 하고 싶을 수 있습니다.

`express.Router()` 객체는 `app` 객체처럼 자신만의 `.use()` 메서드를 가질 수 있습니다. 이를 이용해 특정 라우터에만 종속되는 미들웨어를 만들 수 있으며, 이를 **라우터 레벨 미들웨어(Router-Level Middleware)** 라고 부릅니다.

---

### 라우터 레벨 미들웨어 적용하기

다시 '시청'과 '부서' 비유를 들어볼까요? `app.use()`가 시청 전체에 적용되는 규칙이라면, `productRouter.use()`는 '상품 관리 부서'에 들어오는 사람들에게만 적용되는 특별 규칙(예: "상품 관리 부서 출입 시, 담당자에게 서명받기")을 만드는 것과 같습니다.

`productRouter`의 가장 위쪽에 `.use()`를 사용해 미들웨어를 추가해 보겠습니다.

```javascript
// src/app.js
import express from 'express';

const app = express();
const PORT = 3000;

const productRouter = express.Router();

// 👇 '상품 관리 부서'에만 적용되는 규칙을 추가합니다.
productRouter.use((req, res, next) => {
  console.log('📦 Product Router에 방문하셨군요!');
  next();
});

// '상품 관리 부서'의 업무들 (라우트 핸들러)
productRouter.route('/').get(/* ... */).post(/* ... */);
productRouter.route('/:id').patch(/* ... */).delete(/* ... */);

// 시청(app)에 '상품 관리 부서'를 '/products' 경로로 등록합니다.
app.use('/products', productRouter);

app.listen(PORT, () => {
  console.log(`🚀 Server started on port ${PORT}`);
});
```

이제 `/products` 또는 `/products/1`처럼 `productRouter`가 처리하는 어떤 경로로 요청을 보내든, 터미널에는 항상 아래 메시지가 먼저 출력될 것입니다.

```bash
📦 Product Router에 방문하셨군요!
```

---

### 다른 라우터에는 적용되지 않을까?

라우터 레벨 미들웨어는 정말 해당 라우터에만 적용될까요? 확인을 위해 '사용자 관리 부서'에 해당하는 `userRouter`를 추가해 보겠습니다.

```javascript
// src/app.js
import express from 'express';

const app = express();
const PORT = 3000;

// --- 상품 라우터 (위와 동일) ---
const productRouter = express.Router();
productRouter.use((req, res, next) => {
  console.log('📦 Product Router에 방문하셨군요!');
  next();
});
productRouter.route('/').get((req, res) => res.json({ message: 'Product 목록 보기' }));
// ... (나머지 productRouter 코드)

// --- 사용자 라우터 (새로 추가) ---
const userRouter = express.Router();
userRouter.get('/', (req, res) => {
  res.json({ message: 'User 목록 조회' });
});

// --- 각 부서를 시청에 등록 ---
app.use('/products', productRouter);
app.use('/users', userRouter);

app.listen(PORT, () => {
  console.log(`🚀 Server started on port ${PORT}`);
});
```

- `GET /products`로 요청 보내기 → 터미널에 `📦 Product Router...` 메시지 **출력됨**
- `GET /users`로 요청 보내기 → 터미널에 `📦 Product Router...` 메시지 **출력되지 않음**

결과에서 볼 수 있듯이, `productRouter`에 설정된 규칙은 `userRouter`에는 전혀 영향을 주지 않습니다.

이처럼 라우터 레벨 미들웨어는 **특정 기능 그룹에 대한 공통 로직**을 적용할 때 매우 강력합니다. 예를 들어, `/admin`으로 시작하는 모든 경로는 관리자만 접근할 수 있도록 인증을 체크하는 미들웨어를 `adminRouter`에만 적용하는 식으로 활용할 수 있습니다.
