## 쿼리 스트링(Query String) 처리하기 📜

웹 개발을 하다 보면, 클라이언트가 서버에 데이터를 요청할 때 특정 조건을 붙여서 보내고 싶을 때가 있습니다. 예를 들어, "최신순으로 정렬해줘"라거나 "상위 5개만 보여줘" 같은 요청이죠. 이럴 때 사용하는 것이 바로 **쿼리 스트링(Query String)** 입니다.

### 쿼리 스트링이란?

쿼리 스트링이란 URL의 맨 끝에 `?`와 함께 붙어, 서버에 추가적인 정보를 전달하는 역할을 합니다. `key=value` 형태로 구성되며, 여러 개를 전달할 때는 `&` 기호로 연결합니다.

예를 들어, 아래 URL을 살펴볼까요?

`http://localhost:3000/tasks?sort=oldest&count=3`

이 URL은 `tasks` 데이터를 요청하면서 두 가지 조건을 함께 보냈습니다.

- `?` : 여기서부터 쿼리 스트링이 시작돼요.
- `sort=oldest` : 'sort'라는 키(key)에 'oldest'라는 값(value)을 담아, **오래된 순서**로 정렬해달라고 요청하고 있어요.
- `&` : 또 다른 조건을 추가로 연결해요.
- `count=3` : 'count'라는 키(key)에 '3'이라는 값(value)을 담아, **3개**의 데이터만 가져오겠다고 요청하고 있어요.

정리하자면, **GET 요청**을 보낼 때 데이터 목록을 필터링하거나 정렬하는 등, 원하는 조건에 맞춰 데이터를 가공해서 받아보고 싶을 때 유용하게 사용됩니다.

> **💡 잠깐\! REST Client 팁**
> VS Code의 확장 프로그램인 'REST Client'를 사용하신다면, `.http` 파일 내에서 `###` 구분자를 사용해 여러 개의 요청을 깔끔하게 나눠서 작성하고 테스트할 수 있습니다.

```http
# 1. 기본 tasks 목록 요청
GET http://localhost:3000/tasks

###

 # 2. 쿼리 스트링을 포함한 tasks 목록 요청
GET http://localhost:3000/tasks?sort=oldest\&count=3
```

### Express에서 쿼리 스트링 다루기

이제 Express.js 환경에서 쿼리 스트링을 어떻게 처리하는지 코드를 통해 알아보겠습니다.

먼저, 어떤 쿼리 파라미터를 처리할지 미리 주석으로 상세하게 기록해두면 협업하거나 나중에 코드를 다시 볼 때 큰 도움이 됩니다.

```javascript
// node01-start-javascript-backend/todo-api/app.js
import express from 'express';
import tasks from './data/mock.js';

const app = express();

app.get('/tasks', (req, res) => {
  /**
   * 쿼리 파라미터를 받아 task 목록을 정렬하고 개수를 제한합니다.
   * sort - 'oldest'인 경우 오래된 순, 그 외에는 최신 순으로 정렬합니다. (기본값: 최신 순)
   * count - 응답으로 보낼 task의 최대 개수입니다.
   */

  // 1. req.query 객체에서 쿼리 파라미터 가져오기
  const { sort, count: countStr } = req.query;
  const count = Number(countStr);

  // 2. sort 조건에 따라 사용할 비교 함수 정의하기
  // createdAt은 Date 객체이므로 빼기(-) 연산을 통해 시간 순서를 비교할 수 있습니다.
  const compareFn =
    sort === 'oldest'
      ? (a, b) => a.createdAt - b.createdAt // 오름차순 (오래된 순)
      : (a, b) => b.createdAt - a.createdAt; // 내림차순 (최신 순)

  // 3. 원본 배열을 보존하며 정렬 및 개수 제한 적용하기
  // ❗️ 중요: .sort()는 원본 배열을 직접 수정합니다.
  // 따라서 스프레드 문법(...)으로 배열의 복사본을 만들어 정렬해야 원본 데이터(tasks)가 변경되지 않습니다.
  let newTasks = [...tasks].sort(compareFn);

  // count 파라미터가 유효한 숫자일 경우, 개수 제한하기
  if (count) {
    newTasks = newTasks.slice(0, count);
  }

  res.send(newTasks);
});

app.listen(3000, () => {
  console.log('Server started on port 3000');
  console.log(`http://localhost:3000`);
});
```

코드를 단계별로 살펴볼까요?

1.  **파라미터 가져오기**: Express는 클라이언트가 보낸 쿼리 스트링을 자동으로 파싱하여 `req.query` 객체에 담아줍니다. `req.query.sort`, `req.query.count` 와 같이 각 키에 해당하는 값을 쉽게 꺼내 쓸 수 있습니다.
2.  **값 변환**: 쿼리 스트링으로 전달된 모든 값은 **문자열**입니다. 따라서 `count`처럼 숫자로 사용해야 할 값은 `Number()` 함수를 통해 숫자 타입으로 변환해줍니다.
3.  **정렬 로직**: `sort` 값에 따라 다른 정렬 기준을 적용하기 위해 삼항 연산자를 사용했습니다. `sort`가 `'oldest'`이면 오래된 순(오름차순), 그 외의 모든 경우(값이 없거나 다른 값일 때)는 최신 순(내림차순)으로 정렬됩니다.
4.  **불변성 유지**: `[...tasks].sort(compareFn)` 부분은 매우 중요합니다. JavaScript의 `Array.prototype.sort()` 메서드는 원본 배열 자체를 정렬해버립니다. 만약 원본인 `tasks` 배열을 직접 정렬하면, 서버가 실행되는 동안 `tasks` 데이터의 순서가 영구적으로 바뀌게 됩니다. 이를 방지하기 위해 **스프레드 문법(`...`)** 을 사용해 `tasks` 배열의 **복사본**을 만든 후, 그 복사본을 정렬하는 것이 안전하고 좋은 방법입니다.
5.  **개수 제한**: `count` 값이 있다면, `slice(0, count)`를 이용해 배열의 맨 처음부터 `count`개만큼의 요소만 잘라내어 `newTasks`에 다시 할당합니다.

---

### 실행 결과 확인하기

이제 실제로 요청을 보내서 결과가 어떻게 달라지는지 확인해봅시다.

#### 1. 쿼리 스트링 없이 요청

`GET http://localhost:3000/tasks`

쿼리 스트링이 없으므로, 기본 정렬 방식인 **최신 순**으로 모든 `task`가 정렬되어 반환됩니다.

```json
HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8
...

[
  {
    "id": 5,
    "title": "파이썬 공부",
    "description": "프로그래밍 시작하기 in Python 토픽 끝내기",
    "isComplete": false,
    "createdAt": "2023-03-23T06:34:11.617Z",
    "updatedAt": "2023-03-23T06:34:11.617Z"
  },
  {
    "id": 4,
    "title": "독서",
    "description": "30 페이지",
    "isComplete": false,
    "createdAt": "2023-03-23T06:34:10.617Z",
    "updatedAt": "2023-03-23T06:34:10.617Z"
  },
  // ... (이하 생략)
]
```

#### 2. `sort=oldest&count=3` 쿼리 스트링과 함께 요청

`GET http://localhost:3000/tasks?sort=oldest&count=3`

`sort`와 `count` 조건이 모두 적용되어, **오래된 순**으로 정렬된 `task` 중 **상위 3개**만 반환됩니다.

```json
HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8
...

[
  {
    "id": 1,
    "title": "30분 운동",
    "isComplete": false,
    "createdAt": "2023-03-23T06:34:07.617Z",
    "updatedAt": "2023-03-23T06:34:07.617Z"
  },
  {
    "id": 2,
    "title": "리액트 공부",
    "description": "Tic Tac Toe 게임 완성하기",
    "isComplete": true,
    "createdAt": "2023-03-23T06:34:08.617Z",
    "updatedAt": "2023-03-23T06:34:08.617Z"
  },
  {
    "id": 3,
    "title": "집 청소",
    "isComplete": true,
    "createdAt": "2023-03-23T06:34:09.617Z",
    "updatedAt": "2023-03-23T06:34:09.617Z"
  }
]
```

이렇게 Express의 `req.query`를 활용하면 쿼리 스트링을 간단하고 효과적으로 처리하여, 유연하고 강력한 API를 만들 수 있습니다. 😊
