## ✨ Mongoose로 데이터 생성 및 유효성 검사하기 (POST)

이제 Mongoose를 사용해 MongoDB에 새로운 데이터를 **생성(Create)** 하는 방법을 알아보고, 데이터의 품질을 보장하는 **유효성 검사(Validation)** 기능까지 적용해 보겠습니다.

### 1. Mongoose로 데이터 생성하기

기존에 mock 데이터를 사용했을 때는 `id`, `isComplete`, `createdAt` 같은 필드들을 우리가 직접 수동으로 설정해야 했습니다.

#### 📜 수정 전 (Before - mock 데이터 사용)

```javascript
app.post('/tasks', (req, res) => {
  const newTask = req.body;
  // id, isComplete, createdAt, updatedAt 필드를 수동으로 설정
  const ids = mockTasks.map((task) => task.id);
  newTask.id = Math.max(...ids) + 1;
  newTask.isComplete = false;
  newTask.createdAt = new Date();
  newTask.updatedAt = new Date();

  mockTasks.push(newTask);
  res.status(201).send(newTask);
});
```

하지만 Mongoose 스키마에 `default`와 `timestamps` 옵션을 설정했기 때문에, 이제 이런 부가적인 정보들은 Mongoose와 MongoDB가 알아서 처리해줍니다. 우리는 클라이언트로부터 받은 데이터(`req.body`)만 `Task.create()` 메소드에 넘겨주면 됩니다.

#### ✨ 수정 후 (After - Mongoose 사용)

```javascript
// /app.js
app.post('/tasks', async (req, res) => {
  // Task 모델의 create 메소드로 req.body의 내용을 DB에 저장합니다.
  const newTask = await Task.create(req.body);
  // 성공 시 201 Created 상태 코드와 생성된 데이터를 응답합니다.
  res.status(201).send(newTask);
});
```

#### ✅ 테스트 및 결과 확인

이제 API를 테스트해보면, `title`과 `description`만 보냈는데도 `_id`, `isComplete`, `createdAt`, `updatedAt` 필드가 모두 자동으로 채워져서 응답이 오는 것을 확인할 수 있습니다.

**[요청]**

```http
POST http://localhost:3000/tasks
Content-Type: application/json

{
  "title": "게임하기",
  "description": "명조:워더링웨이브 일일 퀘스트 수행"
}
```

**[응답]**

```json
HTTP/1.1 201 Created
//...
{
  "title": "게임하기",
  "description": "명조:워더링웨이브 일일 퀘스트 수행",
  "isComplete": false,
  "_id": "68a810968b27a64929ecd9a8",
  "createdAt": "2025-08-22T06:39:18.894Z",
  "updatedAt": "2025-08-22T06:39:18.894Z",
  "__v": 0
}
```

`GET /tasks`로 전체 목록을 조회해도 데이터가 잘 추가된 것을 볼 수 있으며, 서버를 재시작해도 데이터가 사라지지 않습니다\!

---

### 🛡️ 데이터의 품질을 지키는 문지기, 유효성 검사 (Validation)

지금은 `title` 필드 없이 요청을 보내도 데이터가 생성됩니다. 하지만 '제목 없는 할 일'은 데이터로서 의미가 없죠. 이처럼 **데이터가 올바른 형식과 필수 정보를 갖추었는지 검사**하는 과정을 **유효성 검사(Validation)** 라고 합니다.

Mongoose는 스키마를 정의할 때 아주 간편하게 유효성 검사 규칙을 추가할 수 있습니다.

#### 1\. Mongoose 기본 내장 유효성 검사기 (Built-in Validators)

Mongoose는 자주 사용되는 유효성 검사 규칙들을 미리 만들어 제공합니다.

| 속성            | 데이터 타입 | 설명                                              |
| :-------------- | :---------- | :------------------------------------------------ |
| **`required`**  | 모든 타입   | `true`일 경우, 이 필드는 필수 항목이 됩니다.      |
| **`minLength`** | `String`    | 문자열의 최소 길이를 지정합니다.                  |
| **`maxLength`** | `String`    | 문자열의 최대 길이를 지정합니다.                  |
| **`min`**       | `Number`    | 숫자의 최솟값을 지정합니다.                       |
| **`max`**       | `Number`    | 숫자의 최댓값을 지정합니다.                       |
| **`enum`**      | `String`    | 이 필드에 허용되는 값들을 배열 형태로 지정합니다. |

ex) enum: ['Low', 'Medium', 'High'] => 'Low' or 'Medium' or 'High'

이 규칙들을 `Task` 스키마에 적용하여 더 견고하게 만들어 보겠습니다.

```javascript
// /models/Task.js
const TaskSchema = new mongoose.Schema(
  {
    title: {
      type: String,
      required: true, // title 필드는 필수!
      minLength: 2, // 최소 2글자 이상
      maxLength: 50, // 최대 50글자 이하
    },
    description: {
      type: String,
    },
    isComplete: {
      type: Boolean,
      default: false,
    },
  },
  {
    timestamps: true,
  }
);
```

이제 `title` 없이 요청을 보내거나(`required` 위반), 50자가 넘는 `title`을 보내거나(`maxLength` 위반), `priority`에 'Very High' 같은 허용되지 않은 값을 보내면 Mongoose가 `ValidationError`라는 오류를 발생시켜 데이터 생성을 막습니다.

> **⚠️ 서버가 죽는다고요?**
> 현재 상태에서 유효성 검사에 실패하면 `ValidationError`가 발생하며 서버가 멈춥니다. 사용자의 잘못된 입력 때문에 서버가 멈추는 것은 심각한 문제입니다. 이 문제는 **에러 핸들링 미들웨어**를 통해 해결할 수 있으며, 나중에 더 자세히 다루게 됩니다.

#### 2\. 커스텀 유효성 검사 (`validate`)

Mongoose가 제공하는 기본 규칙 외에, 직접 만든 함수로 유효성을 검사할 수도 있습니다. 예를 들어, `title`이 최소 2단어 이상이어야 한다는 규칙을 추가해 보겠습니다.

```javascript
// /models/Task.js
const TaskSchema = new mongoose.Schema({
  title: {
    type: String,
    required: true,
    maxLength: 30,
    validate: {
      validator: function (title) {
        // title을 공백으로 나눈 배열의 길이가 2 이상이어야 true를 반환
        return title.split(' ').length >= 2;
      },
      message: '제목은 두 단어 이상으로 작성해야 합니다.', // 유효성 검사 실패 시 에러 메시지
    },
  },
  // ...
});
```

이제 `title`에 "과제"처럼 한 단어만 입력해서 요청을 보내면, 우리가 직접 만든 에러 메시지와 함께 `ValidationError`가 발생하는 것을 볼 수 있습니다.

> **💡 스키마에 없는 필드는 어떻게 될까요?**
> Mongoose는 스키마에 정의되지 않은 필드가 요청에 포함되어 있더라도 기본적으로 무시하고 저장하지 않습니다. 따라서 알 수 없는 필드가 들어오는 것에 대해서는 따로 걱정할 필요가 없습니다.

---

### 📚 참고 자료

더 많은 유효성 검사기(validator)에 대한 정보는 Mongoose 공식 문서에서 확인하실 수 있습니다.

- **Mongoose Built-in Validators:** [https://mongoosejs.com/docs/validation.html\#built-in-validators](https://mongoosejs.com/docs/validation.html#built-in-validators)
