## ✍️🗑️ 데이터 수정(PATCH) 및 삭제(DELETE)하기

이제 API의 마지막 핵심 기능인 데이터 수정(Update)과 삭제(Delete) 로직을 mock 데이터 대신 Mongoose를 사용하도록 변경해 보겠습니다. 이 가이드를 보기 전에, 비동기 에러 처리에 대한 이해가 필요하니 이전 글을 꼭 먼저 읽어주세요\!

### 1. 데이터 수정하기 (PATCH)

`PATCH /tasks/:id` 라우트는 먼저 ID에 해당하는 `task`를 찾은 뒤, 요청 본문(request body)의 내용으로 기존 데이터를 수정하는 역할을 합니다.

#### 📜 수정 전 (Before - mock 데이터 사용)

```javascript
app.patch('/tasks/:id', (req, res) => {
  const id = Number(req.params.id);
  const task = mockTasks.find((task) => task.id === id);

  if (task) {
    Object.keys(req.body).forEach((key) => {
      task[key] = req.body[key];
    });
    task.updatedAt = new Date(); // 수동으로 수정 시각 업데이트
    res.send(task);
  } else {
    res.status(404).send({ message: 'Cannot find given id.' });
  }
});
```

#### ✨ 수정 후 (After - Mongoose 사용)

Mongoose를 사용하면 "데이터를 찾고, 수정한 뒤, 저장하는" 흐름으로 코드를 작성할 수 있습니다.

```javascript
app.patch(
  '/tasks/:id',
  asyncHandler(async (req, res) => {
    const id = req.params.id;
    // 1. ID로 데이터를 찾습니다.
    const task = await Task.findById(id);

    if (task) {
      // 2. 요청 본문의 필드를 기존 데이터에 덮어씌웁니다.
      Object.keys(req.body).forEach((key) => {
        task[key] = req.body[key];
      });
      // 3. 수정한 데이터를 저장합니다. 이 과정에서 timestamps가 자동으로 업데이트됩니다.
      await task.save();
      res.send(task);
    } else {
      res.status(404).send({ message: 'Cannot find given id.' });
    }
  })
);
```

- `await Task.findById(id)`: ID로 MongoDB에서 해당 문서를 찾습니다.
- `Object.keys(...)`: 찾은 `task` 문서의 속성을 요청 body의 내용으로 변경합니다.
- `await task.save()`: 변경된 내용을 데이터베이스에 저장합니다. 이 메소드를 호출하면 Mongoose 스키마에 정의된 **유효성 검사(validation)가 실행**되고, `timestamps` 옵션에 따라 `updatedAt` 필드가 자동으로 갱신됩니다.

> **💡 `.save()` vs `.findByIdAndUpdate()`**
> Mongoose에는 `Task.findByIdAndUpdate(id, req.body)`처럼 데이터를 찾고 업데이트하는 것을 한 번에 처리하는 편리한 메소드도 있습니다.
> 하지만 **`findByIdAndUpdate()`는 기본적으로 유효성 검사를 실행하지 않는다**는 중요한 차이점이 있습니다. 유효성 검사를 실행하려면 `{ runValidators: true }` 옵션을 추가로 전달해야 합니다.
> 따라서, **데이터 수정 시 유효성 검사가 반드시 필요하다면 `.save()` 메소드를 사용하는 것이 더 안전하고 직관적인 방법**입니다.

---

### 2. 데이터 삭제하기 (DELETE)

`DELETE /tasks/:id` 라우트는 특정 ID에 해당하는 데이터를 찾아서 삭제합니다.

#### 📜 수정 전 (Before - mock 데이터 사용)

```javascript
app.delete('/tasks/:id', (req, res) => {
  const id = Number(req.params.id);
  const idx = mockTasks.findIndex((task) => task.id === id);

  if (idx >= 0) {
    mockTasks.splice(idx, 1);
    res.sendStatus(204);
  } else {
    res.status(404).send({ message: 'Cannot find given id.' });
  }
});
```

#### ✨ 수정 후 (After - Mongoose 사용)

Mongoose는 ID로 문서를 찾아 바로 삭제하는 `findByIdAndDelete()` 메소드를 제공합니다.

```javascript
app.delete(
  '/tasks/:id',
  asyncHandler(async (req, res) => {
    const id = req.params.id;
    // 1. ID로 데이터를 찾아 삭제합니다. DB 작업이므로 await는 필수!
    const task = await Task.findByIdAndDelete(id);

    // 2. task가 성공적으로 삭제되었으면(null이 아니면) 204 응답을 보냅니다.
    if (task) {
      res.sendStatus(204);
    } else {
      res.status(404).send({ message: 'Cannot find given id.' });
    }
  })
);
```

- `await Task.findByIdAndDelete(id)`: ID에 해당하는 문서를 찾아서 삭제합니다.
- 이 메소드는 삭제된 문서를 반환하며, 만약 해당 ID의 문서가 없다면 `null`을 반환합니다. 이를 이용해 `if (task)` 조건문으로 성공/실패를 구분할 수 있습니다.

---

### ✅ API 테스트 및 결과 확인

이제 모든 CRUD 기능이 MongoDB와 연동되었습니다. API 테스트를 통해 확인해 봅시다.

**[데이터 수정]**

```http
PATCH http://localhost:3000/tasks/68a7efff0b4c24193c10d093
Content-Type: application/json

{
  "title": "저녁 약속",
  "description": "강남역 돈까스!"
}
```

→ `200 OK`와 함께 수정된 데이터가 응답으로 오면 성공입니다. `updatedAt` 필드의 시간이 변경된 것을 확인해 보세요.

**[데이터 삭제]**

```http
DELETE http://localhost:3000/tasks/68a7efff0b4c24193c10d093
```

→ `204 No Content` 응답이 오면 성공입니다. 이후 `GET /tasks`로 확인해 보면 해당 데이터가 사라진 것을 볼 수 있습니다.

> **🔄 데이터 초기화가 필요하다면?**
> 테스트 중에 데이터를 처음 상태로 되돌리고 싶다면, 이전에 만들었던 시드 스크립트를 실행하세요.
> `npm run seed`

이제 여러분의 API 서버는 데이터베이스를 통해 데이터를 생성, 조회, 수정, 삭제하는 모든 핵심 기능을 갖추게 되었습니다\! 🎉
