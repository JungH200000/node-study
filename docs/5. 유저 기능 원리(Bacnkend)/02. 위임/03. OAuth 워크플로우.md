## OAuth 워크플로우

OAuth의 주체들과 사전 준비물에 대해 알아봤습니다. 이제 모든 준비가 끝났으니, 이들이 실제로 어떻게 상호작용하며 권한을 위임하는지, 그 **워크플로우(Workflow)** 를 단계별로 따라가 보겠습니다.

### 🕺 OAuth는 '정해진 순서의 춤'과 같아요

워크플로우란 **어떤 목표를 이루기 위한 정해진 작업의 흐름**입니다. 식당에서 손님이 주문하고, 종업원이 주문을 받고, 요리사가 요리하는 정해진 순서가 있는 것처럼요. 각자는 자신의 역할과 순서만 알면, 전체 시스템이 원활하게 돌아갑니다.

OAuth의 워크플로우도 여러 주인공들이 정해진 순서에 따라 통신하며 '접근 권한 위임'이라는 목표를 달성하는 과정입니다.

> **💡 잠깐, 너무 복잡해 보이나요?**
>
> 지금부터 살펴볼 과정이 다소 복잡하게 느껴질 수 있지만, 걱정하지 마세요! 이 과정에서 **'인가 서버'** 와 **'리소스 서버'** 의 역할(예: 구글, 페이스북)은 우리가 직접 만들 필요가 없습니다. 우리는 **'클라이언트'(`ChatGPT` 등)** 의 프론트엔드와 백엔드 로직에만 집중하면 되며, 이마저도 대부분 잘 만들어진 라이브러리를 사용해 편리하게 구현할 수 있습니다. 지금은 전체적인 '흐름'을 이해하는 데 집중해 주세요!

---

### 🚶‍♂️ 8단계로 따라가는 OAuth 2.0 여정

가장 널리 쓰이는 **'인증 코드 승인 방식(Authorization Code Grant)'** 의 흐름을 따라가 보겠습니다.

#### **1부: 사용자의 동의와 '임시 허가증' 발급**

`[ 사용자 브라우저 ↔ 인가 서버(구글) ]` 사이에서 일어나는 일입니다.

1.  **사용자의 권한 요청 시작**
    사용자가 `ChatGPT` 사이트에서 '구글 캘린더 연동하기' 버튼을 클릭합니다.

2.  **구글로 이동**
    `ChatGPT`의 프론트엔드는 사용자를 구글 **인가 서버**가 제공하는 로그인 및 권한 동의 페이지로 보냅니다(리디렉션).

3.  **사용자 인증 및 권한 동의**
    사용자는 구글 로그인 페이지에서 아이디와 비밀번호를 입력하여 **본인임을 인증**합니다. 그 후, "`ChatGPT`가 당신의 캘린더를 읽고 쓸 수 있도록 허용하시겠습니까?" 와 같은 **권한 동의(Scope) 화면**에서 '동의' 버튼을 누릅니다.

4.  **'임시 허가증(Authorization Code)' 발급**
    사용자의 동의를 확인한 구글 인가 서버는, "이 사용자가 `ChatGPT`에게 권한을 위임하는 것을 허락했습니다"라는 증표로, 일회성의 짧은 **`Authorization Code`(임시 허가증)** 를 생성합니다. 그리고 사용자의 브라우저를 다시 `ChatGPT` 사이트로 돌려보내면서, 이 코드를 함께 전달합니다.

---

#### **2부: 백엔드의 '만능 열쇠' 교환**

`[ ChatGPT 프론트엔드 → ChatGPT 백엔드 → 인가 서버(구글) ]` 사이에서 일어나는 일입니다.

5.  **'임시 허가증'을 백엔드로 전달**
    `ChatGPT` 프론트엔드는 구글로부터 받은 `Authorization Code`를 자신의 **백엔드 서버**로 안전하게 전달합니다.

6.  **'만능 열쇠(Access Token)' 요청**
    `ChatGPT` **백엔드**는 방금 받은 **`Authorization Code`** 에, 미리 발급받아 뒀던 자신의 신분증인 **`Client ID`** 와 **`Client Secret`** 을 함께 담아 구글 **인가 서버**로 "이제 진짜 권한을 주세요!" 라고 요청을 보냅니다.
    _(사용자 동의(Code)와 앱 신원(ID/Secret)을 모두 확인하여 보안을 강화하는 단계입니다.)_

7.  **'만능 열쇠(Access Token)' 최종 발급**
    모든 정보가 유효함을 확인한 구글 인가 서버는, 드디어 `ChatGPT` 백엔드에게 앞으로 구글 캘린더에 접근할 때 사용할 수 있는 **`Access Token`(만능 열쇠)** 을 발급해줍니다.

---

#### **3부: 드디어 리소스 접근!**

`[ ChatGPT 백엔드 ↔ 리소스 서버(구글 캘린더) ]` 사이에서 일어나는 일입니다.

8.  **API 호출**
    `ChatGPT` 백엔드는 발급받은 `Access Token`을 `Authorization` 헤더에 담아 구글 캘린더 **리소스 서버**에 "152번 사용자의 내일 일정을 알려주세요" 와 같이 API를 요청합니다. 리소스 서버는 이 토큰이 유효한지, 그리고 요청한 작업이 허용된 범위(Scope) 내에 있는지 확인한 후, 데이터를 제공합니다.

이 `Access Token`이 만료되면, 클라이언트는 저장해 둔 `Refresh Token`(만약 있다면)을 사용해 6~7단계를 다시 수행하여 새로운 `Access Token`을 발급받게 됩니다.

---

### ✍️ 마무리하며

- **OAuth 2.0**은 사용자의 **비밀번호를 직접 공유하지 않고도** 제3자 애플리케이션에 안전하게 **접근 권한을 위임**할 수 있게 해주는 표준 프로토콜입니다.
- 이 과정은 크게 **(1) 사용자의 동의를 얻어 `Authorization Code`를 발급**받는 단계와, **(2) 애플리케이션이 `Authorization Code`를 사용하여 실제 API 호출에 필요한 `Access Token`으로 교환**하는 단계로 나뉩니다.
- 비록 절차는 다소 복잡해 보이지만, 각 단계는 사용자와 애플리케이션 모두의 보안을 지키기 위한 중요한 약속들로 이루어져 있습니다. 우리가 매일 사용하는 '소셜 로그인' 기능이 바로 이 견고한 워크플로우 위에서 동작하고 있습니다.
