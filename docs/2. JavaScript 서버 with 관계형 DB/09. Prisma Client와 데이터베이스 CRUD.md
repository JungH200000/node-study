## ⚡️ Prisma Client로 CRUD API 구현하기

데이터베이스 설계와 마이그레이션을 마쳤으니, 이제 **Prisma Client**를 사용해 실제 데이터를 생성(Create), 조회(Read), 수정(Update), 삭제(Delete)하는 **CRUD** API를 구현해 보겠습니다. 비어있던 Express 라우트에 생명을 불어넣을 시간입니다\!

### 1. 사전 준비: 기본 코드 작성하기

먼저, 프로젝트의 루트 경로(`e-commerce/`)에 `app.js` 파일을 만들고, API 테스트를 위해 `http/` 폴더와 그 안에 `users.http` 파일을 생성합니다.

#### `app.js`: API 서버 기본 구조

기본적인 Express 서버 구조와 User CRUD를 위한 5개의 라우트를 미리 준비합니다.

```javascript
// /app.js
import express from 'express';
import dotenv from 'dotenv';
// ... PrismaClient import 예정 ...

dotenv.config();

// ... PrismaClient 인스턴스 생성 예정 ...

const app = express();
app.use(express.json());

app.get('/users', async (req, res) => {
  /* 유저 목록 조회 */
});
app.get('/users/:id', async (req, res) => {
  /* id로 유저 조회 */
});
app.post('/users', async (req, res) => {
  /* 유저 생성 */
});
app.patch('/users/:id', async (req, res) => {
  /* 유저 정보 수정 */
});
app.delete('/users/:id', async (req, res) => {
  /* 유저 삭제 */
});

app.listen(process.env.PORT || 3000, () => {
  console.log('🚀 Server Started');
});
```

#### `http/users.http`: API 테스트를 위한 요청들

API가 잘 만들어졌는지 테스트하기 위한 요청들을 미리 작성해 둡니다.

```http
// /http/users.http

# 모든 유저 조회
GET http://localhost:3000/users

###

# 특정 ID의 유저 조회 (ID는 테스트 시 실제 값으로 변경)
GET http://localhost:3000/users/your-user-id-here

###

# 새로운 유저 생성
POST http://localhost:3000/users
Content-Type: application/json

{
  "email": "gildong@example.com",
  "firstName": "길동",
  "lastName": "홍",
  "address": "서울특별시 강남구"
}

###

# 유저 정보 수정 (ID는 테스트 시 실제 값으로 변경)
PATCH http://localhost:3000/users/your-user-id-here
Content-Type: application/json

{
  "address": "제주특별자치도 서귀포시"
}

###

# 유저 삭제 (ID는 테스트 시 실제 값으로 변경)
DELETE http://localhost:3000/users/your-user-id-here
```

---

### 2. Prisma Client 준비하기

Prisma로 데이터베이스 CRUD 작업을 하려면 **Prisma Client**가 필요합니다. Prisma Client는 우리가 `schema.prisma`에 정의한 모델 정보를 바탕으로 생성되며, 데이터베이스와 상호작용하는 모든 메소드를 제공합니다.

`app.js` 파일 상단에 `PrismaClient`를 `import`하고 인스턴스를 생성합니다.

```javascript
// /app.js
import express from 'express';
import dotenv from 'dotenv';
import { PrismaClient } from './generated/prisma/index.js';

dotenv.config();

const prisma = new PrismaClient();
const app = express();
// ...
```

이제 `prisma`라는 변수를 통해 모든 데이터베이스 작업을 수행할 수 있습니다. 기본 사용법은 **`prisma.모델이름.동작`** 형태입니다. (`schema.prisma`의 `User` 모델은 `prisma.user`로 접근합니다.)

---

### 3. Prisma로 CRUD API 구현하기

이제 각 라우트 핸들러를 Prisma Client 메소드로 채워보겠습니다.

#### R: 데이터 조회하기 (Read)

##### 모든 유저 조회: `findMany()`

```javascript
// GET /users
app.get('/users', async (req, res) => {
  const users = await prisma.user.findMany();
  res.send(users);
});
```

`findMany()`는 해당 모델의 모든 데이터를 배열 형태로 가져옵니다.

##### 특정 유저 조회: `findUnique()`

```javascript
// GET /users/:id
app.get('/users/:id', async (req, res) => {
  const { id } = req.params;
  // @id나 @unique 필드로 데이터를 찾을 때는 findUnique를 사용합니다.
  const user = await prisma.user.findUnique({
    where: { id },
  });
  res.send(user);
});
```

`findUnique()`는 `@id`나 `@unique` 같은 고유 필드를 기준으로 단 하나의 데이터를 찾습니다.

#### C: 데이터 생성하기 (Create)

##### 유저 생성: `create()`

```javascript
// POST /users
app.post('/users', async (req, res) => {
  // 요청 body의 내용으로 새로운 유저를 생성합니다.
  const user = await prisma.user.create({
    data: req.body,
  });
  res.status(201).send(user);
});
```

`create()` 메소드는 `data` 속성에 전달된 객체의 내용으로 새로운 데이터를 생성합니다.

#### U: 데이터 수정하기 (Update)

##### 유저 정보 수정: `update()`

```javascript
// PATCH /users/:id
app.patch('/users/:id', async (req, res) => {
  const { id } = req.params;
  // id로 특정 유저를 찾아, 요청 body의 내용으로 정보를 수정합니다.
  const user = await prisma.user.update({
    where: { id },
    data: req.body,
  });
  res.send(user);
});
```

`update()` 메소드는 `where`로 수정할 데이터를 찾고, `data`로 전달된 내용으로 정보를 업데이트합니다.

#### D: 데이터 삭제하기 (Delete)

##### 유저 삭제: `delete()`

```javascript
// DELETE /users/:id
app.delete('/users/:id', async (req, res) => {
  const { id } = req.params;
  // id로 특정 유저를 찾아 삭제합니다.
  await prisma.user.delete({
    where: { id },
  });
  res.sendStatus(204);
});
```

`delete()` 메소드는 `where`로 삭제할 데이터를 찾아 제거합니다.

> **💡 Prisma의 일관성 있는 문법** > `where`로 대상을 지정하고 `data`로 내용을 전달하는 방식은 `create`, `update` 등 여러 메소드에서 일관되게 사용됩니다. 이 패턴에 익숙해지면 Prisma를 아주 쉽게 다룰 수 있습니다.

---

### ✅ 최종 코드 및 테스트

지금까지의 모든 CRUD 로직을 반영한 `app.js`의 전체 모습과, `users.http` 파일을 이용한 테스트 결과를 확인해 보세요. `POST`로 유저를 생성하고, `GET`으로 확인한 뒤, `PATCH`로 주소를 바꾸고, 마지막으로 `DELETE`로 삭제하는 모든 과정이 정상적으로 동작하는 것을 볼 수 있습니다.

이제 여러분의 API는 Prisma Client를 통해 실제 데이터베이스와 완벽하게 소통할 수 있게 되었습니다\! 🎉
