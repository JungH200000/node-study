## ✨ Prisma Client 고급 기능: 심화 쿼리 마스터하기

Prisma Client는 기본적인 CRUD 기능 외에도, 더 복잡하고 효율적인 데이터 처리를 위한 다양한 추가 기능들을 제공합니다. 더 똑똑하게 데이터를 다룰 수 있게 해주는 Prisma Client의 추가 메소드와 필터 조건들에 대해 알아봅시다.

---

### 1. 알아두면 쓸모있는 추가 CRUD 메소드

#### `findFirst()`

`findUnique()`는 `@id`나 `@unique` 필드로만 데이터를 조회할 수 있었습니다. 만약 **고유하지 않은 필드(non-unique)를 조건으로 첫 번째 데이터 하나만** 찾고 싶다면 `findFirst()`를 사용합니다.

```javascript
// 'firstName'이 '길동'인 첫 번째 유저를 찾는다.
const user = await prisma.user.findFirst({
  where: { firstName: '길동' },
  // 어떤 '첫 번째'를 찾을지 순서를 지정할 수도 있다.
  orderBy: { createdAt: 'asc' }, // 가장 오래된 유저부터 찾기
});
```

#### `upsert()`

`upsert()`는 **'update or insert'** 의 줄임말로, 조건에 맞는 데이터가 **있으면 수정하고, 없으면 생성**하는 아주 유용한 메소드입니다.

`upsert()`는 `where`, `update`, `create` 세 가지 옵션을 받습니다.

1.  `where`: 데이터를 찾을 고유한 조건을 지정합니다.
2.  `update`: `where` 조건에 맞는 데이터가 있을 경우, 이 내용으로 **수정**합니다.
3.  `create`: `where` 조건에 맞는 데이터가 없을 경우, 이 내용으로 데이터를 **생성**합니다.

```javascript
// yjkim@example.com 이메일을 가진 유저를 찾아서,
// 있으면 주소를 업데이트하고, 없으면 새로운 유저로 생성한다.
const user = await prisma.user.upsert({
  where: { email: 'yjkim@example.com' },
  update: { address: '서울특별시 강남구' },
  create: {
    email: 'yjkim@example.com',
    firstName: '유진',
    lastName: '김',
    address: '충청북도 청주시',
  },
});
```

#### `count()`

조건을 만족하는 데이터의 **개수**만 필요할 때는 `count()`를 사용하는 것이 효율적입니다. `findMany()`로 모든 데이터를 가져와 배열의 길이를 세는 것보다 훨씬 빠릅니다.

```javascript
// 'FASHION' 카테고리에 해당하는 상품의 총개수를 센다.
const count = await prisma.product.count({
  where: {
    category: 'FASHION',
  },
});
```

> **📚 참고 자료**
> 더 많은 Prisma Client 메소드가 궁금하다면 공식 문서를 참고하세요.
> [Prisma Client API Reference - Model Queries](https://www.prisma.io/docs/orm/reference/prisma-client-reference#model-queries)

---

### 2. 더 강력하게 필터링하기

`where` 옵션 안에서 다양한 비교 연산자와 논리 연산자를 조합하여 훨씬 더 정교한 데이터 조회가 가능합니다.

#### 기본 비교 연산자

| 연산자           | 설명                                       | 예시                            |
| :--------------- | :----------------------------------------- | :------------------------------ |
| **`not`**        | 값이 일치하지 않는 데이터                  | `{ not: 'FASHION' }`            |
| **`in`**         | 배열에 포함된 값 중 하나와 일치하는 데이터 | `{ in: ['FASHION', 'BEAUTY'] }` |
| **`contains`**   | 특정 문자열을 포함하는 데이터              | `{ contains: 'TV' }`            |
| **`startsWith`** | 특정 문자열로 시작하는 데이터              | `{ startsWith: 'Apple' }`       |

**'FASHION' 카테고리가 아닌(`not`) 상품들 필터링**

```javascript
// catrgory가 'FASHION'이 아닌 Product들 필터
const products = await prisma.product.findMany({
  where: {
    category: {
      not: 'FASHION',
    },
  },
});

// category가 'FASHION', 'SPORTS', 'BEAUTY' 중 하나인 Product들 필터
const products = await prisma.product.findMany({
  where: {
    category: {
      in: ['FASHION', 'SPORTS', 'BEAUTY'],
    },
  },
});

// name에 'TV'가 들어가는 Product들 필터
const products = await prisma.product.findMany({
  where: {
    category: {
      contains: 'TV',
    },
  },
});

// name이 'Apple'로 시작하는 Product들 필터
const products = await prisma.product.findMany({
  where: {
    name: {
      startWith: 'Apple',
    },
  },
});
```

#### 논리 연산자 (`AND`, `OR`, `NOT`)

##### AND (모든 조건 만족)

여러 조건을 **모두 만족**하는 데이터를 찾으려면, `where` 객체 안에 여러 필터를 나열하면 됩니다. (기본 동작)

**'FASHION' 카테고리이면서 `name`에 '나이키'가 들어가는 상품들 필터링**

```javascript
const products = await prisma.product.findMany({
  where: {
    category: 'FASHION',
    name: {
      contains: '나이키',
    },
  },
});
```

##### OR (하나라도 만족)

여러 조건 중 **하나라도 만족**하는 데이터를 찾으려면 `OR` 연산자를 사용하고, 조건들을 배열로 묶어줍니다.

**`name`에 '아디다스'가 들어가거나 '나이키'가 들어가는 상품들 필터링**

```javascript
const products = await prisma.product.findMany({
  where: {
    OR: [
      {
        name: {
          contains: '아디다스',
        },
      },
      {
        name: {
          contains: '나이크',
        },
      },
    ],
  },
});
```

##### NOT (조건 불만족)

**특정 조건을 제외**한 데이터를 찾으려면 `NOT` 연산자를 사용합니다.

**`name`에 '삼성'이 들어가지만, 'TV'는 들어가지 않는 상품들 필터링**

```javascript
const product = await prisma.product.findMany({
  where: {
    name: {
      contains: '삼성',
    },
    NOT: {
      name: {
        contains: 'TV',
      },
    },
  },
});
```

> **📚 참고 자료**
> 더 많은 필터 조건과 연산자가 궁금하다면 공식 문서를 참고하세요.
> [Prisma Client API Reference - Filter conditions and operators](https://www.prisma.io/docs/orm/reference/prisma-client-reference#filter-conditions-and-operators)
