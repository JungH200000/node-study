## 🔢 데이터 가공하기: 계산된 필드(Computed Field) 추가하기

데이터베이스에서 조회한 데이터를 그대로 반환할 때도 있지만, 종종 여러 필드의 값을 조합하여 **계산된 새로운 값을 추가**해서 보내줘야 할 때가 있습니다.

예를 들어, 특정 주문(`Order`)의 상세 내역을 조회할 때, 각 주문 상품(`OrderItem`)들의 가격과 수량을 바탕으로 **주문 총액**을 계산해서 함께 보여주는 경우입니다. 이렇게 기존 데이터를 바탕으로 동적으로 계산되는 필드를 **계산된 필드(Computed Field)** 라고 부릅니다.

### 1단계: 계산에 필요한 데이터 함께 조회하기

주문 총액을 계산하려면, 먼저 특정 `Order`에 속한 모든 `OrderItem`들의 정보가 필요합니다. `GET /orders/:id` 라우트에서 `include` 옵션을 사용하여 `orderItems`를 함께 조회합니다.

```javascript
// /app.js
app.get(
  '/orders/:id',
  asyncHandler(async (req, res) => {
    const { id } = req.params;
    const order = await prisma.order.findUniqueOrThrow({
      where: { id },
      include: {
        orderItems: true, // 주문 상품들을 함께 조회
      },
    });

    // ... (계산 로직 추가 예정)
  })
);
```

### # 2단계: 계산 로직 구현하기

Prisma는 조회 결과를 일반적인 JavaScript 객체(또는 객체의 배열)로 반환하기 때문에, 응답을 보내기 전에 자유롭게 데이터를 가공할 수 있습니다. `order.orderItems` 배열을 순회하며 총액을 계산해 보겠습니다.

#### **방법 1: `forEach` 반복문 사용 (직관적인 방법)**

```javascript
let total = 0;
order.orderItems.forEach((item) => {
  total += item.unitPrice * item.quantity;
});
```

#### **방법 2: `reduce` 메소드 사용 (간결하고 함수형인 방법)**

배열의 `reduce` 메소드를 사용하면 여러 값을 하나의 결과값으로 깔끔하게 줄일 수 있습니다.

```javascript
const total = order.orderItems.reduce((sum, item) => {
  return sum + item.unitPrice * item.quantity;
}, 0); // 0은 sum의 초기값
```

두 방법 모두 결과는 동일하며, `reduce` 방식이 더 간결하여 최신 JavaScript에서 선호되는 경향이 있습니다.

---

### ✅ 최종 코드 및 결과 확인

계산된 `total` 값을 `order` 객체에 새로운 속성으로 추가한 뒤, 클라이언트에 응답으로 보냅니다.

```javascript
// /app.js
app.get(
  '/orders/:id',
  asyncHandler(async (req, res) => {
    const { id } = req.params;
    const order = await prisma.order.findUniqueOrThrow({
      where: { id },
      include: {
        orderItems: true,
      },
    });

    // 1. forEach 사용해 주문 총액(total) 계산
    let total = 0;
    order.orderItems.forEach((orderItem) => {
      total += orderItem.unitPrice * orderItem.quantity;
    });

    // 2. 조회된 order 객체에 total 필드를 추가
    order.total = total;

    // 3. 계산된 필드가 포함된 최종 객체를 응답으로 전송
    res.send(order);
  })
);
```

**[API 테스트]**
`GET http://localhost:3000/orders/dedd2a7f-56c4-45b7-a37d-efdc1d2f518d`

**[응답 결과]**
이제 응답 객체의 맨 마지막에 `total` 필드가 성공적으로 추가된 것을 볼 수 있습니다.

```json
{
  "id": "dedd2a7f-56c4-45b7-a37d-efdc1d2f518d",
  "status": "PENDING",
  // ...
  "orderItems": [
    {
      "id": "f753a259-1e26-4ed9-9e60-099a4a06af4f",
      "unitPrice": 320000,
      "quantity": 1
      // ...
    }
    // ...
  ],
  "total": 847000 // ✨ 계산된 필드 추가 완료!
}
```
