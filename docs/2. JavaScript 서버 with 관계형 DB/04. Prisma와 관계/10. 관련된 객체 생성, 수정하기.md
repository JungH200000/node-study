## âœ¨ í•œ ë²ˆì˜ ìš”ì²­ìœ¼ë¡œ í•¨ê»˜\! ê´€ë ¨ëœ ê°ì²´ ìƒì„± ë° ìˆ˜ì •í•˜ê¸°

ì§€ê¸ˆê¹Œì§€ëŠ” `User`ë¥¼ ìƒì„±í•œ ë’¤, ë³„ë„ì˜ ìš”ì²­ìœ¼ë¡œ `UserPreference`ë¥¼ ë§Œë“¤ê³  ì—°ê²°í•´ì•¼ í–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ Prismaì˜ **ì¤‘ì²© ì“°ê¸°(Nested Writes)** ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´, **ë‹¨ í•œ ë²ˆì˜ API ìš”ì²­**ìœ¼ë¡œ `User`ì™€ `UserPreference`ë¥¼ **ë™ì‹œì— ìƒì„±í•˜ê±°ë‚˜ ìˆ˜ì •**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ í¸ì˜ì„±ì„ í¬ê²Œ ë†’ì—¬ì£¼ëŠ” ë§¤ìš° ê°•ë ¥í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.

---

### 1. `User`ì™€ `UserPreference` í•¨ê»˜ ìƒì„±í•˜ê¸° (Nested Create)

#### 1ë‹¨ê³„: API ìš”ì²­ í˜•ì‹ ë³€ê²½

ë¨¼ì €, í´ë¼ì´ì–¸íŠ¸ê°€ `User` ì •ë³´ì™€ `UserPreference` ì •ë³´ë¥¼ í•œ ë²ˆì— ë³´ë‚¼ ìˆ˜ ìˆë„ë¡ API ìš”ì²­ í˜•ì‹ì„ ì„¤ê³„í•©ë‹ˆë‹¤.

```http
# /http/users.http

POST http://localhost:3000/users
Content-Type: application/json

{
  "email": "hyun@example.com",
  "firstName": "ì‚¬",
  "lastName": "í˜„",
  "address": "ë¶€ì‚°ê´‘ì—­ì‹œ ë¶êµ¬",
  "userPreference": {
    "receiveEmail": false
  }
}
```

`req.body` ì•ˆì— `userPreference` ê°ì²´ê°€ ì¤‘ì²©ë˜ì–´ ë“¤ì–´ì˜¤ëŠ” í˜•íƒœì…ë‹ˆë‹¤.

#### 2ë‹¨ê³„: ìœ íš¨ì„± ê²€ì‚¬ Struct ì—…ë°ì´íŠ¸

ìƒˆë¡œìš´ ìš”ì²­ í˜•ì‹ì— ë§ê²Œ `structs.js`ì˜ `CreateUser`ë¥¼ ìˆ˜ì •í•˜ì—¬, `userPreference` ê°ì²´ì— ëŒ€í•œ ìœ íš¨ì„± ê²€ì‚¬ ê·œì¹™ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

```javascript
// /structs.js
export const CreateUser = s.object({
  email: s.define('Email', isEmail),
  firstName: s.size(s.string(), 1, 30),
  lastName: s.size(s.string(), 1, 30),
  address: s.string(),
  userPreference: s.object({
    receiveEmail: s.boolean(),
  }),
});
```

#### 3ë‹¨ê³„: `POST /users` ë¼ìš°íŠ¸ êµ¬í˜„í•˜ê¸°

ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ì—ì„œ `req.body`ë¡œë¶€í„° `userPreference` ë°ì´í„°ì™€ ë‚˜ë¨¸ì§€ `userFields`ë¥¼ ë¶„ë¦¬í•œ ë’¤, Prismaì˜ `create` ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ë‘ ë°ì´í„°ë¥¼ ë™ì‹œì— ìƒì„±í•©ë‹ˆë‹¤.

```javascript
// /app.js
app.post(
  '/users',
  asyncHandler(async (req, res) => {
    assert(req.body, CreateUser);

    // 1. req.bodyì—ì„œ userPreferenceì™€ ë‚˜ë¨¸ì§€ userFieldsë¥¼ ë¶„ë¦¬í•©ë‹ˆë‹¤.
    const { userPreference, ...userFields } = req.body;

    const user = await prisma.user.create({
      data: {
        // 2. userFieldsëŠ” ê·¸ëŒ€ë¡œ ì „ë‹¬í•˜ê³ ,
        ...userFields,
        // 3. userPreference ê´€ê³„ í•„ë“œ ì•ˆì— create ì˜µì…˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        userPreference: {
          create: userPreference,
        },
      },
      // 4. ìƒì„±ëœ userPreference ì •ë³´ë„ í•¨ê»˜ ë°˜í™˜í•˜ë„ë¡ include ì˜µì…˜ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
      include: {
        userPreference: true,
      },
    });
    res.status(201).send(user);
  })
);
```

> **ğŸ’¡ ë‚˜ë¨¸ì§€ ì—°ì‚°ì(`...`)ë¥¼ ì´ìš©í•œ ê°ì²´ ë¶„ë¦¬**
>
> `const { userPreference, ...userFields } = req.body;`ëŠ” êµ¬ì¡° ë¶„í•´ í• ë‹¹ê³¼ ë‚˜ë¨¸ì§€ ì—°ì‚°ìë¥¼ í•¨ê»˜ ì‚¬ìš©í•œ ë§¤ìš° ìœ ìš©í•œ íŒ¨í„´ì…ë‹ˆë‹¤. `req.body`ì—ì„œ `userPreference` ì†ì„±ì„ ì¶”ì¶œí•˜ì—¬ `userPreference` ë³€ìˆ˜ì— ë‹´ê³ , **ê·¸ê²ƒì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ëª¨ë“  ì†ì„±**ë“¤ì„ `userFields`ë¼ëŠ” ìƒˆë¡œìš´ ê°ì²´ì— ëª¨ì•„ì¤ë‹ˆë‹¤.

#### âœ… ê²°ê³¼ í™•ì¸

ìš”ì²­ì„ ë³´ë‚´ë©´ `User`ì™€ `UserPreference`ê°€ í•¨ê»˜ ìƒì„±ë˜ê³ , ì„œë¡œì˜ IDë¡œ ì—°ê²°ëœ ì™„ì „í•œ ë°ì´í„°ê°€ ì‘ë‹µìœ¼ë¡œ ëŒì•„ì˜µë‹ˆë‹¤.

```json
{
  "id": "b54f6175-d7b9-43c3-b39a-4e7dddc0ee14",
  "email": "hyun@example.com",
  // ...
  "userPreference": {
    "id": "04b17225-da15-43f1-9346-3f451fc67fed",
    "receiveEmail": false,
    "userId": "b54f6175-d7b9-43c3-b39a-4e7dddc0ee14"
  }
}
```

---

### 2. `User`ì™€ `UserPreference` í•¨ê»˜ ìˆ˜ì •í•˜ê¸° (Nested Update)

ë°ì´í„° ìˆ˜ì •ë„ ìƒì„±ê³¼ ê±°ì˜ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ, ê´€ê³„ í•„ë“œ ì•ˆì—ì„œ `create` ëŒ€ì‹  `update` ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

#### `PATCH /users/:id` ë¼ìš°íŠ¸ êµ¬í˜„í•˜ê¸°

```javascript
// /app.js
app.patch(
  '/users/:id',
  asyncHandler(async (req, res) => {
    assert(req.body, PatchUser);
    const { userPreference, ...userFields } = req.body;
    const { id } = req.params;

    const user = await prisma.user.update({
      where: { id },
      data: {
        ...userFields, // User ì •ë³´ ì—…ë°ì´íŠ¸
        userPreference: {
          update: userPreference, // ê´€ë ¨ëœ UserPreference ì •ë³´ ì—…ë°ì´íŠ¸
        },
      },
      include: {
        userPreference: true,
      },
    });
    res.send(user);
  })
);
```

#### âœ… í…ŒìŠ¤íŠ¸ ë° ê²°ê³¼ í™•ì¸

ì•„ë˜ì™€ ê°™ì´ `email`ê³¼ `userPreference.receiveEmail`ì„ ë™ì‹œì— ìˆ˜ì •í•˜ëŠ” ìš”ì²­ì„ ë³´ë‚´ë©´, ë‘ ë°ì´í„°ê°€ ëª¨ë‘ ì—…ë°ì´íŠ¸ë˜ì–´ ì‘ë‹µë©ë‹ˆë‹¤.

```http
PATCH http://localhost:3000/users/b54f6175-d7b9-43c3-b39a-4e7dddc0ee14
Content-Type: application/json

{
  "email": "hyunSass@example.com",
  "userPreference": {
    "receiveEmail": true
  }
}
```

Prismaì˜ ì¤‘ì²© ì“°ê¸° ê¸°ëŠ¥ì„ í™œìš©í•˜ë©´, ì—¬ëŸ¬ ë²ˆì˜ API í˜¸ì¶œì„ í•œ ë²ˆìœ¼ë¡œ ì¤„ì—¬ ë” íš¨ìœ¨ì ì´ê³  í¸ë¦¬í•œ APIë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
