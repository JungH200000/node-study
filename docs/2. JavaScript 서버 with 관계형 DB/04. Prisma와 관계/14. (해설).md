```js
// /app.js

app.post(
  '/orders',
  asyncHandler(async (req, res) => {
    assert(req.body, CreateOrder);
    const { userId, orderItems } = req.body;

    const productIds = orderItems.map((orderItem) => orderItem.productId);

    // ...

    const order = await prisma.order.create({
      // ...
    });

    for (const productId of productIds) {
      await prisma.product.update({
        where: { id: productId },
        data: {
          stock: {
            decrement: getQuantity(productId),
          },
        },
      });
    }

    res.status(201).send(order);
  })
);
```

다만, Prisma 연산은 Promise를 반환하는 비동기 작업이기 때문에 연산을 하나하나 `await`하는 것은 효율적이지 않다. Promise를 만들고 `Promise.all()`로 기다리면 더 효율적인 코드를 작성할 수 있다.

```js
// /app.js
//...
    // Order 생성하고 재고 감소
    const order = await prisma.order.create({
      data: {
        userId,
        orderItems: {
          create: orderItems,
        },
      },
      include: {
        orderItems: true,
      },
    });

    // 재고 감소
    const UpdateQueries = productIds.map((productId) =>
      prisma.product.update({
        where: { id: productId },
        data: { stock: { decrement: getQuantity(productId) } },
      })
    );

    await Promise.all(UpdateQueries);

    res.status(201).send(order);
  })
);
```
