## 🔗 관계 정의하기 (2): 일대일 및 다대다 관계

이전 가이드에서 일대다(1:N) 관계를 성공적으로 정의해 보았습니다. 이제 나머지 관계 유형인 **일대일(1:1)** 과 **다대다(N:N)** 관계를 Prisma 스키마에 정의하는 방법을 마스터해 보겠습니다.

---

### 1. 🤝 일대일(1:1) 관계 정의하기: User ↔️ UserPreference

`User`와 `UserPreference`(사용자 설정)는 **1:1 관계**입니다. 이 관계를 Prisma 스키마에 구현하는 과정은 Prisma의 동작 방식을 이해하는 좋은 기회입니다.

#### 1단계: Prisma의 기본 동작 확인하기

먼저 `UserPreference` 모델에 `User`를 가리키는 관계 필드 `user`를 추가하고 저장(포맷팅)해 봅시다.

```prisma
model UserPreference {
  // ...
  user User
}
```

파일을 저장하면, Prisma 확장 프로그램이 자동으로 코드를 완성시켜주는데, 자세히 보면 우리가 원하던 1:1 관계가 아닌 **1:N 관계**로 만들어진 것을 볼 수 있습니다.

```prisma
// Prisma가 자동으로 완성해 준 1:N 관계 (아직 수정 전!)
model User {
  // ...
  userPreference UserPreference[] // User가 여러 개의 UserPreference를 가짐 (?)
}

model UserPreference {
  // ...
  user   User   @relation(fields: [userId], references: [id])
  userId String // 외래 키
}
```

Prisma는 기본적으로 관계를 1:N으로 추측하기 때문입니다. 이제 이 코드를 올바른 1:1 관계로 수정해 보겠습니다.

#### 2단계: 1:1 관계로 수정하기

1:1 관계를 만들기 위한 핵심 규칙은 두 가지입니다.

1.  양쪽 모델의 관계 필드가 모두 단일 객체를 가리키도록 `[]`를 제거합니다.
2.  외래 키(`userId`) 필드에 `@unique` 속성을 추가하여, 하나의 `User`가 여러 `UserPreference`에 연결될 수 없도록 막습니다.

<!-- end list -->

```prisma
// 올바른 1:1 관계로 수정한 코드
model User {
  // ...
  userPreference UserPreference // 1. 배열(`[]`) 제거
}

model UserPreference {
  // ...
  user   User   @relation(fields: [userId], references: [id])
  userId String @unique // 2. @unique 속성 추가
}
```

#### 3단계: 필수 관계 오류 해결하기

코드를 수정하면 `userPreference` 필드에 새로운 오류가 표시됩니다.

> Error: The relation field `userPreference` on Model `User` is required. This is not valid... Please change the field type from `UserPreference` to `UserPreference?` to fix this.

이 오류는 "모든 `User`가 `UserPreference`를 '반드시' 가져야 한다는 규칙은 데이터베이스 레벨에서 강제할 수 없어\!"라는 의미입니다. `User`를 생성하는 시점에는 `UserPreference`가 아직 없을 수도 있기 때문이죠.

해결책은 오류 메시지가 제안한 대로, `User` 모델의 `userPreference` 필드를 **선택 사항**으로 만들어주는 것입니다.

```prisma
// 최종 1:1 관계 코드
model User {
  // ...
  userPreference UserPreference? // '?'를 추가하여 선택적 관계로 변경
}

model UserPreference {
  // ...
  user   User   @relation(fields: [userId], references: [id])
  userId String @unique
}
```

이제 `User`와 `UserPreference` 사이의 완벽한 1:1 관계 정의가 끝났습니다.

---

### 2. ✨ 다대다(N:N) 관계 정의하기: User ↔️ Product (찜하기)

`User`와 `Product`의 '찜하기' 관계는 **N:N (다대다)** 관계입니다. 데이터베이스에서는 이 관계를 위해 중간에 **정션 테이블(Junction Table)** 이 필요하다고 배웠죠.

하지만 Prisma를 사용하면 이 과정이 마법처럼 간단해집니다. 우리는 정션 테이블을 직접 정의할 필요 없이, **양쪽 모델에 서로를 가리키는 관계 필드(배열 형태)를 추가**하기만 하면 됩니다.

```prisma
// N:N 관계 정의
model User {
  // ...
  savedProducts Product[] // 찜한 Product 목록
}

model Product {
  // ...
  savedByUsers User[] // 자신을 찜한 User 목록
}
```

이것이 전부입니다\! 이렇게 양쪽에 배열 형태의 관계 필드를 정의하면, Prisma는 이를 **암시적 다대다 관계(Implicit Many-to-Many)** 로 인지하고, 마이그레이션 시 `_UserToProduct`와 같은 이름의 정션 테이블을 **자동으로 생성하고 관리**해줍니다.

---

### 🚀 마이그레이션 및 결과 확인

이제 모든 관계 정의가 끝났으니, 마이그레이션을 통해 데이터베이스에 최종 변경사항을 적용합니다.

```bash
npx prisma migrate dev --name add_user_user_preference_and_user_product_relations
```

마이그레이션이 성공하면 `npx prisma studio`를 실행하여 결과를 확인해 보세요.

- `User` 모델에 `userPreference`와 `savedProducts` 관계 필드가 추가되었습니다.
- `Product` 모델에는 `savedByUsers` 관계 필드가 추가되었습니다.
- `UserPreference` 모델의 `userId` 필드에는 `Unique` 제약조건이 걸린 것을 볼 수 있습니다.

이제 Prisma 스키마에 모든 개체와 관계를 완벽하게 정의했습니다\! 🎉
