## 🔗 관계의 생명주기 관리: `onDelete` 옵션

Prisma 스키마에서 관계를 정의할 때 `@relation` 속성 안에 **`onDelete`** 옵션을 추가하여, **연결된 데이터가 삭제될 때 어떤 일이 벌어질지**에 대한 규칙을 정할 수 있습니다.

예를 들어, 한 명의 유저가 탈퇴(삭제)했을 때, 그 유저가 남긴 주문(Order) 기록은 어떻게 처리해야 할까요? 함께 삭제해야 할까요, 아니면 기록을 위해 남겨둬야 할까요? `onDelete` 옵션은 바로 이런 상황에 대한 '대응 계획'을 데이터베이스 레벨에서 설정하는 중요한 기능입니다.

자주 사용하는 4가지 옵션을 알아봅시다.

---

### `onDelete` 옵션 종류

#### 1\. `Cascade` (연쇄 삭제)

외래 키가 가리키는 데이터가 삭제되면, **해당 데이터를 참조하던 데이터도 함께 삭제**됩니다.

```prisma
model Order {
  // ...
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
}
```

- **예시**: `User` 테이블에서 '홍길동' 유저가 삭제되면, '홍길동'의 `userId`를 가지고 있던 모든 `Order` 데이터도 함께 연쇄적으로 삭제됩니다.

#### 2\. `Restrict` (삭제 제한)

삭제하려는 데이터를 참조하는 데이터가 하나라도 남아있으면, **삭제 자체를 막습니다.**

```prisma
model Order {
  // ...
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)
  userId String
}
```

- **예시**: `Order` 테이블에 '홍길동' 유저의 주문이 하나라도 남아있다면, `User` 테이블에서 '홍길동' 유저를 삭제하려고 할 때 오류가 발생합니다. 유저를 삭제하려면, 먼저 해당 유저의 모든 주문을 삭제해야 합니다.

#### 3\. `SetNull` (연결 끊기)

외래 키가 가리키는 데이터가 삭제되면, 외래 키 필드의 값을 **`NULL`로 설정**합니다. (즉, 관계의 연결고리만 끊습니다.)

```prisma
model Order {
  // ...
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId String?
}
```

- **예시**: `User` 테이블에서 '홍길동' 유저가 삭제되면, '홍길동'의 주문 데이터들은 삭제되지 않고 `userId` 필드만 `NULL`로 변경됩니다.
- **주의**: 이 옵션을 사용하려면 외래 키 필드와 관계 필드가 반드시 **선택 사항(`?`)** 이어야 합니다.

#### 4\. `SetDefault` (기본값으로 설정)

외래 키가 가리키는 데이터가 삭제되면, 외래 키 필드의 값을 **미리 지정된 `@default` 값으로 설정**합니다.

```prisma
model Order {
  // ...
  user   User   @relation(fields: [userId], references: [id], onDelete: SetDefault)
  userId String @default("default-user-id")
}
```

- **예시**: `User` 테이블에서 유저가 삭제되면, 해당 유저의 주문들은 `userId`가 `"default-user-id"`라는 기본값으로 변경됩니다. (예: '탈퇴한 회원'을 가리키는 ID)
- **주의**: 이 옵션을 사용하려면 외래 키 필드에 `@default` 속성이 반드시 설정되어 있어야 합니다.

> **💡 Prisma의 기본 `onDelete` 정책**
>
> `onDelete` 옵션을 따로 설정하지 않으면, Prisma는 관계 필드의 필수/선택 여부에 따라 다음과 같이 기본값을 적용합니다.
>
> - **관계 필드가 필수일 경우 (예: `user User`)**: `Restrict` (참조하는 데이터가 있으면 삭제 방지)
> - **관계 필드가 선택일 경우 (예: `user User?`)**: `SetNull` (참조 데이터 삭제 시 `NULL`로 변경)

---

### 📝 우리 스키마에 적용하기

이제 우리 e-커머스 스키마에 적절한 `onDelete` 규칙을 적용해 봅시다.

#### `UserPreference` (1:1 관계)

사용자 설정(`UserPreference`)은 사용자가 존재할 때만 의미가 있습니다. 따라서 `User`가 삭제되면 `UserPreference`도 함께 삭제되는 것이 자연스럽습니다. → **`Cascade`**

```prisma
// /prisma/schema.prisma
model UserPreference {
  // ...
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique
}
```

#### `Order` (1:N 관계)

사용자가 탈퇴하더라도, 매출 기록 등 비즈니스에 중요한 주문(`Order`) 데이터는 남겨두는 것이 좋습니다. 대신 주문자와의 연결만 끊어주면 됩니다. → **`SetNull`**

이를 위해 `user`와 `userId` 필드를 선택 사항(`?`)으로 변경하고 `onDelete: SetNull` 옵션을 추가합니다.

```prisma
// /prisma/schema.prisma
model Order {
  // ...
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId String?
  // ...
}
```

이렇게 변경하는 것은 "하나의 주문은 반드시 한 명의 유저를 가져야 한다"는 기존 규칙(최소 카디널리티 1)에서 "유저가 삭제되는 예외적인 상황까지 고려하여, 유저 없이도 주문 기록이 남을 수 있다" (최소 카디널리티 0)로 비즈니스 규칙을 확장하는 것과 같습니다.

---

### ✅ 마이그레이션

스키마에 새로운 규칙들을 추가했으니, 마이그레이션을 통해 데이터베이스에 적용합니다.

```bash
npx prisma migrate dev --name change_on_delete_constraints
```

이제 여러분의 데이터베이스는 데이터 간의 관계가 끊어질 때 어떻게 행동해야 하는지에 대한 명확한 규칙까지 갖추게 되었습니다\!

---

### 📚 참고 자료

- **Prisma 공식 문서 - onDelete**
  https://www.prisma.io/docs/orm/prisma-schema/data-model/relations/referential-actions
