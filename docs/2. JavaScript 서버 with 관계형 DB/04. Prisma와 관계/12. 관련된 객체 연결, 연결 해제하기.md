## 🔗 이미 존재하는 데이터 연결하기: `connect`와 `disconnect`

이전 가이드에서는 `User`를 생성하면서 `UserPreference`를 **함께 생성**하는 방법을 배웠습니다. 하지만 `User`가 `Product`를 '찜'하는 경우처럼, **이미 존재하는 데이터들 사이에 새로운 관계를 맺어주어야** 할 때가 더 많습니다.

Prisma는 **`connect`** 와 **`disconnect`** 라는 직관적인 옵션을 통해, 이런 다대다(N:N) 관계를 아주 쉽게 관리할 수 있게 해줍니다.

---

### 1. 관계 연결하기 (`connect`)

'김영희'라는 유저가 '쿠진앤에이 오믈렛 팬' 상품을 찜 목록에 추가하는 API를 만든다고 가정해 봅시다.

#### 1단계: API 엔드포인트 및 요청 정의

'어떤 유저'(`userId`)가 '어떤 상품'(`productId`)을 찜하는지 명확히 나타내는 API를 설계합니다. `POST` 메소드를 사용해 '찜'이라는 새로운 관계를 생성합니다.

**엔드포인트**: `POST /users/:id/saved-products`
**요청 Body**:

```json
{
  "productId": "c28a2eaf-4d87-4f9f-ae5b-cbcf73e24253"
}
```

#### 2단계: 유효성 검사 Struct 만들기

요청 Body로 들어오는 `productId`가 유효한 UUID 형식인지 검사하는 `struct`를 `structs.js`에 추가합니다.

```javascript
// /structs.js
// ...

const Uuid = s.define('Uuid', (value) => isUuid.v4(value));

export const PostSavedProduct = s.object({
  productId: Uuid,
});
```

#### 3단계: `connect`를 사용해 관계 생성하기

이제 `app.js`에 실제 로직을 구현합니다. 특정 유저 정보를 **수정(`update`)** 하여, `savedProducts` 목록에 새로운 상품을 **연결(`connect`)** 하는 방식으로 접근합니다.

```javascript
// /app.js
// ...

app.post(
  '/users/:id/saved-products',
  asyncHandler(async (req, res) => {
    assert(req.body, PostSavedProduct);
    const { id: userId } = req.params; // 파라미터 id를 userId로 이름 변경
    const { productId } = req.body;

    const user = await prisma.user.update({
      where: { id: userId },
      data: {
        // savedProducts 관계 필드에 connect 옵션을 사용
        savedProducts: {
          connect: {
            id: productId, // id가 productId인 상품과 연결
          },
        },
      },
      include: {
        savedProducts: true, // 업데이트된 찜 목록 전체를 반환
      },
    });

    res.send(user.savedProducts);
  })
);
```

> **✨ `connect`의 역할**
>
> `connect: { id: productId }` 코드가 실행되면, Prisma는 `User`와 `Product` 사이의 숨겨진 **정션 테이블(`_UserToProduct`)** 에 `userId`와 `productId`를 한 줄 추가하여 두 데이터의 관계를 맺어줍니다. 우리는 복잡한 중간 과정을 신경 쓸 필요 없이, 단지 '연결하라'고 명령만 내리면 됩니다.

#### 4단계: 테스트 및 결과 확인

API를 테스트해 보면, 기존 찜 목록에 새로운 상품이 추가되어 총 5개의 상품 목록이 반환되는 것을 확인할 수 있습니다.

---

### 2. 관계 연결 해제하기 (`disconnect`)

찜하기를 취소하는 기능은 `connect`의 반대인 **`disconnect`** 를 사용하면 간단하게 구현할 수 있습니다. '찜'이라는 관계를 삭제하는 것이므로, `DELETE` HTTP 메소드를 사용하는 것이 RESTful API 설계에 적합합니다.

**엔드포인트**: `DELETE /users/:userId/saved-products/:productId`

```javascript
// /app.js

app.delete(
  '/users/:userId/saved-products/:productId',
  asyncHandler(async (req, res) => {
    const { userId, productId } = req.params;

    await prisma.user.update({
      where: { id: userId },
      data: {
        // savedProducts 관계 필드에 disconnect 옵션을 사용
        savedProducts: {
          disconnect: {
            id: productId, // id가 productId인 상품과의 연결을 해제
          },
        },
      },
    });

    res.sendStatus(204);
  })
);
```

`connect`와 문법은 동일하지만, `disconnect`는 정션 테이블에서 해당하는 `userId`와 `productId` 행을 찾아 **삭제**하여 두 데이터의 관계를 끊어줍니다.

Prisma의 `connect`와 `disconnect`를 활용하면, 다대다 관계를 마치 간단한 목록에 아이템을 추가하고 제거하는 것처럼 직관적으로 다룰 수 있습니다.
