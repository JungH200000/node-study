## 🏗️ 살아있는 데이터베이스 변경하기: Prisma 마이그레이션 심화

애플리케이션은 살아있는 생물처럼 계속해서 발전하고 진화합니다. 그에 따라 데이터의 구조도 바뀌어야 할 때가 오죠. 예를 들어, 기존 `User` 모델에 `age`(나이) 필드를 새로 추가해야 하는 상황을 가정해 봅시다.

`schema.prisma` 파일에 필드를 추가했으니, 당연히 마이그레이션을 통해 데이터베이스에 이 변경사항을 적용해야 합니다.

### 😱 문제 상황: 데이터가 있는 테이블에 필수 필드 추가하기

먼저, `User` 모델에 필수 필드인 `age`를 추가해 보겠습니다.

```prisma
// /prisma/schema.prisma

model User {
  // ... 기존 필드 생략 ...
  address   String
  age       Int      // 새로운 필수 필드 추가
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

그리고 평소처럼 마이그레이션 명령어를 실행합니다.

```bash
npx prisma migrate dev
```

하지만 이번에는 성공 메시지 대신 오류가 발생합니다.

> **Error:**
> ⚠️ We found changes that cannot be executed:
>
> • Step 0 Added the required column `age` to the `User` table **without a default value.** There are 3 rows in this table, it is not possible to execute this step.

오류 메시지는 아주 친절하게도, **"User 테이블에 이미 3개의 데이터가 있는데, 기본값(default value)도 없는 필수(`age`) 필드를 추가할 수는 없어\!"** 라고 알려주고 있습니다.

기존에 저장된 데이터들은 `age` 필드가 비어있게 되는데, `age`는 필수 필드(non-nullable)라서 값을 비워둘 수 없기 때문에 발생하는 문제입니다.

---

### ✅ 해결 방법 1: 2단계 마이그레이션

이 문제를 해결하는 가장 안전하고 일반적인 방법은 두 단계에 걸쳐 마이그레이션을 진행하는 것입니다.

#### **1단계: 필드를 '선택 사항'으로 먼저 추가하기**

`age` 필드를 필수(`Int`)가 아닌 선택 사항(`Int?`)으로 먼저 추가합니다.

```prisma
model User {
  // ...
  age       Int? // '?'를 붙여 선택 필드로 변경
  // ...
}
```

이제 다시 마이그레이션을 실행합니다. 마이그레이션 이름은 `add_user_age`로 지정해 봅시다.

```bash
npx prisma migrate dev --name add_user_age
```

> **Your database is now in sync with your schema.**

이번에는 마이그레이션이 성공합니다\! `prisma/migrations/..._add_user_age/migration.sql` 파일을 확인해 보면, `User` 테이블에 `age` 열을 추가하는 `ALTER TABLE` 구문이 생성된 것을 볼 수 있습니다.

#### **2단계: 데이터 채우고 '필수 사항'으로 변경하기**

1.  `npx prisma studio`를 실행하여 Prisma Studio를 엽니다.
2.  `User` 모델을 선택하면, 기존 데이터들의 `age` 필드가 비어있는(`null`) 것을 볼 수 있습니다. 이 비어있는 값들을 모두 채워주세요.
3.  데이터를 모두 채웠다면, `schema.prisma` 파일로 돌아와 `age` 필드를 다시 필수 사항으로 변경합니다.

<!-- end list -->

```prisma
model User {
  // ...
  age       Int // '?'를 제거하여 필수 필드로 변경
  // ...
}
```

4.  다시 마이그레이션을 실행합니다. 이번에는 `alter_user_age`와 같이 다른 이름으로 지정합니다.

<!-- end list -->

```bash
npx prisma migrate dev --name alter_user_age
```

이제 모든 기존 데이터가 `age` 값을 가지고 있으므로, 마이그레이션이 성공적으로 완료됩니다.

---

### ✅ 해결 방법 2: `@default` 속성 사용하기

만약 새로 추가하는 필드에 대해, 기존의 모든 데이터에 동일한 기본값을 넣어줘도 괜찮다면 훨씬 간단한 방법이 있습니다. 필드를 추가할 때 `@default` 속성을 함께 사용하는 것입니다.

```prisma
model User {
  // ...
  age       Int @default(20) // 기본값을 20으로 설정
  // ...
}
```

이렇게 하면 마이그레이션 시 Prisma가 기존 데이터들의 `age` 필드에 자동으로 `20`이라는 값을 채워주기 때문에, 한 번의 마이그레이션만으로 문제를 해결할 수 있습니다.

---

### 🗑️ 데이터가 있는 열(Column) 삭제하기

반대로 `age` 필드를 다시 삭제하면 어떻게 될까요?

```prisma
model User {
  // ...
  // age 필드 삭제
  // ...
}
```

필드를 삭제하는 것은 열(column) 전체를 삭제하는 것이므로, 그 안에 있던 데이터도 함께 사라집니다. 그래서 Prisma는 마이그레이션 시 친절한 경고 메시지를 보여줍니다.

> **⚠️ Warnings for the current datasource:**
>
> • You are about to drop the column `age` on the `User` table, which still contains 3 non-null values.
>
> **? Are you sure you want to create and apply this migration? » (y/N)**

"User 테이블의 `age` 열에는 아직 데이터가 있는데, 정말로 삭제하시겠습니까?" 라고 확인하는 과정입니다. `y`를 입력하고 마이그레이션을 진행하면 해당 열이 안전하게 삭제됩니다.

---

### 📝 핵심 정리

- **마이그레이션 파일은 데이터베이스 구조가 변경된 모든 과정을 기록하는 역사책**입니다. 순서대로 적용되기 때문에 함부로 삭제해서는 안 됩니다.
- 데이터 손실이나 제약 조건 위반의 위험이 있을 때, Prisma는 항상 **오류나 경고 메시지**를 보여줍니다. 이 메시지를 잘 읽어보면 대부분의 문제를 해결할 수 있습니다.
