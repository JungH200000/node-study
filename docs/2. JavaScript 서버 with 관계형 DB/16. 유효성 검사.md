## 🛡️ API의 문지기, 유효성 검사(Validation) 추가하기

사용자로부터 들어오는 요청(request) 데이터는 언제나 신뢰할 수 없습니다. 따라서 우리 서버는 데이터베이스에 데이터를 저장하기 전에, 들어온 데이터가 우리가 예상하는 형식과 규칙에 맞는지 반드시 검사해야 합니다. 이 과정을 **유효성 검사(Validation)** 라고 부릅니다.

유효성 검사를 통해 우리는 다음과 같은 것들을 보장할 수 있습니다.

- 필요한 필드가 모두 포함되었는가?
- 각 필드의 데이터 타입(문자열, 숫자 등)이 올바른가?
- 이메일, UUID 등 특별한 형식을 잘 지켰는가?
- 스키마에 정의되지 않은 불필요한 필드는 없는가?

이번에는 Prisma가 추천하는 라이브러리 중 하나인 **`superstruct`** 를 사용해 이 유효성 검사 계층을 구축해 보겠습니다.

### 1. `superstruct` 준비하기

`package.json` 파일이나 터미널에서 `npm list` 명령어로 `superstruct`, `is-email`, `is-uuid` 라이브러리가 설치되어 있는지 확인하고, 없다면 설치해 주세요.
설치 확인: terminal에서 `npm list` 또는 `package.json`

```bash
npm install superstruct is-email is-uuid
```

그다음, 유효성 검사 규칙을 모아둘 `structs.js` 파일을 프로젝트 루트에 생성합니다.

---

### 2. 유효성 검사 '틀(Struct)' 만들기

`superstruct`의 기본 사용법은, 우리가 예상하는 데이터의 '틀(struct)'을 먼저 정의하고, 실제 들어온 데이터가 그 틀에 맞는지 검사하는 것입니다.

#### 1\. 유저 생성(Create)을 위한 Struct 만들기

먼저, 유저를 생성할 때(`POST /users`) 필요한 데이터의 틀인 `CreateUser`를 만들어 보겠습니다.

```javascript
// /structs.js
import * as s from 'superstruct';
import isEmail from 'is-email';

// CreateUser struct를 정의하고 export 합니다.
export const CreateUser = s.object({
  // email 필드는 단순한 문자열이 아닌, 실제 이메일 형식이어야 합니다.
  email: s.define('Email', isEmail),
  // firstName과 lastName은 1~30자 사이의 문자열이어야 합니다.
  firstName: s.size(s.string(), 1, 30),
  lastName: s.size(s.string(), 1, 30),
  address: s.string(),
});
```

- **`s.object({ ... })`**: 객체 형태의 틀을 정의합니다.
- **`s.define('Email', isEmail)`**: `is-email` 라이브러리를 사용해, 문자열이 실제 이메일 형식인지 검사하는 `Email`이라는 새로운 타입을 정의합니다.
- **`s.size(s.string(), 1, 30)`**: 문자열(`s.string()`)의 길이가 1 이상 30 이하인지 검사합니다.

#### 2\. 유저 수정(Patch)을 위한 Struct 만들기

유저 정보를 수정할 때(`PATCH /users/:id`)는 `email`이나 `address`처럼 일부 필드만 요청에 포함될 수 있습니다. 이때는 `s.partial()`을 사용해 기존 Struct의 모든 필드를 '선택 사항'으로 만들 수 있습니다.

```javascript
// /structs.js (CreateUser 아래에 추가)

// CreateUser struct의 모든 필드를 선택 사항으로 변경한 PatchUser를 정의합니다.
export const PatchUser = s.partial(CreateUser);
```

---

### 3. 라우트에 유효성 검사 적용하기

이제 `app.js`의 `POST`와 `PATCH` 라우트 핸들러 맨 위에, `superstruct`의 `assert` 함수를 사용해 유효성 검사 로직을 추가합니다.

```javascript
// /app.js
import express from 'express';
import { assert } from 'superstruct';
import { CreateUser, PatchUser } from './structs.js';
// ...

app.post('/users', async (req, res) => {
  // req.body가 CreateUser struct의 규칙을 통과하는지 검사합니다.
  // 통과하지 못하면 assert가 에러를 발생시켜 아래 코드는 실행되지 않습니다.
  assert(req.body, CreateUser);

  const user = await prisma.user.create({
    data: req.body,
  });
  res.status(201).send(user);
});

app.patch('/users/:id', async (req, res) => {
  // req.body가 PatchUser struct의 규칙을 통과하는지 검사합니다.
  assert(req.body, PatchUser);

  const { id } = req.params;
  const user = await prisma.user.update({
    where: { id },
    data: req.body,
  });
  res.send(user);
});

// ...
```

---

### ✅ 테스트 및 오류 분석

이제 다양한 잘못된 요청을 보내 `superstruct`가 어떻게 우리의 API를 보호하는지 확인해 봅시다.

#### 1\. 잘못된 이메일 형식

`"email": "hyun"`처럼 잘못된 이메일로 요청을 보내면, `s.define`으로 만들었던 `Email` 타입 검사에 실패합니다.

> **`StructError`**: At path: email -- Expected a value of type `Email`, but received: `"hyun"`

#### 2\. 너무 긴 문자열

`firstName`에 30자가 넘는 아주 긴 이름을 담아 보내면, `s.size` 검사에 실패합니다.

> **`StructError`**: At path: firstName -- Expected a string with a length between `1` and `30` but received one with a length of `84`

> **⚠️ `SyntaxError` vs. `StructError`**
> 만약 요청의 JSON 형식 자체가 잘못되었다면(예: 따옴표를 빼먹거나 여러 줄 문자열을 잘못 작성), `superstruct`가 검사하기도 전에 `body-parser` 단계에서 `SyntaxError`가 발생합니다. `SyntaxError`는 '문법' 오류, `StructError`는 '데이터 규칙' 오류라고 생각하면 쉽습니다.

#### 3\. 스키마에 없는 필드 추가

`age`처럼 `CreateUser`에 정의되지 않은 필드를 추가해서 보내면, `never` 타입 오류가 발생하며 요청을 막아줍니다.

> **`StructError`**: At path: age -- Expected a value of type `never`, but received: `20`

#### 4\. 잘못된 데이터 타입

`address`에 문자열이 아닌 숫자를 보내면, `s.string()` 타입 검사에 실패합니다.

> **`StructError`**: At path: address -- Expected a string, but received: 123

이처럼 `superstruct`를 사용하면, 데이터가 실제 로직에 도달하기 전에 여러 규칙 위반 사례들을 효과적으로 차단하여 API의 안정성을 크게 높일 수 있습니다.

---

### 📚 참고 자료

- **Superstruct 기본 타입**: [https://docs.superstructjs.org/api-reference/types](https://docs.superstructjs.org/api-reference/types)
- **Superstruct 상세 규칙 (Refinements)**: [https://docs.superstructjs.org/api-reference/refinements](https://docs.superstructjs.org/api-reference/refinements)
