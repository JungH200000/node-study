## ğŸ›¡ï¸ APIì˜ ë¬¸ì§€ê¸°, ìœ íš¨ì„± ê²€ì‚¬(Validation) ì¶”ê°€í•˜ê¸°

ì‚¬ìš©ìë¡œë¶€í„° ë“¤ì–´ì˜¤ëŠ” ìš”ì²­(request) ë°ì´í„°ëŠ” ì–¸ì œë‚˜ ì‹ ë¢°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ìš°ë¦¬ ì„œë²„ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ë°ì´í„°ë¥¼ ì €ì¥í•˜ê¸° ì „ì—, ë“¤ì–´ì˜¨ ë°ì´í„°ê°€ ìš°ë¦¬ê°€ ì˜ˆìƒí•˜ëŠ” í˜•ì‹ê³¼ ê·œì¹™ì— ë§ëŠ”ì§€ ë°˜ë“œì‹œ ê²€ì‚¬í•´ì•¼ í•©ë‹ˆë‹¤. ì´ ê³¼ì •ì„ **ìœ íš¨ì„± ê²€ì‚¬(Validation)** ë¼ê³  ë¶€ë¦…ë‹ˆë‹¤.

ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í†µí•´ ìš°ë¦¬ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê²ƒë“¤ì„ ë³´ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- í•„ìš”í•œ í•„ë“œê°€ ëª¨ë‘ í¬í•¨ë˜ì—ˆëŠ”ê°€?
- ê° í•„ë“œì˜ ë°ì´í„° íƒ€ì…(ë¬¸ìì—´, ìˆ«ì ë“±)ì´ ì˜¬ë°”ë¥¸ê°€?
- ì´ë©”ì¼, UUID ë“± íŠ¹ë³„í•œ í˜•ì‹ì„ ì˜ ì§€ì¼°ëŠ”ê°€?
- ìŠ¤í‚¤ë§ˆì— ì •ì˜ë˜ì§€ ì•Šì€ ë¶ˆí•„ìš”í•œ í•„ë“œëŠ” ì—†ëŠ”ê°€?

ì´ë²ˆì—ëŠ” Prismaê°€ ì¶”ì²œí•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¤‘ í•˜ë‚˜ì¸ **`superstruct`** ë¥¼ ì‚¬ìš©í•´ ì´ ìœ íš¨ì„± ê²€ì‚¬ ê³„ì¸µì„ êµ¬ì¶•í•´ ë³´ê² ìŠµë‹ˆë‹¤.

### 1. `superstruct` ì¤€ë¹„í•˜ê¸°

`package.json` íŒŒì¼ì´ë‚˜ í„°ë¯¸ë„ì—ì„œ `npm list` ëª…ë ¹ì–´ë¡œ `superstruct`, `is-email`, `is-uuid` ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ì—†ë‹¤ë©´ ì„¤ì¹˜í•´ ì£¼ì„¸ìš”.
ì„¤ì¹˜ í™•ì¸: terminalì—ì„œ `npm list` ë˜ëŠ” `package.json`

```bash
npm install superstruct is-email is-uuid
```

ê·¸ë‹¤ìŒ, ìœ íš¨ì„± ê²€ì‚¬ ê·œì¹™ì„ ëª¨ì•„ë‘˜ `structs.js` íŒŒì¼ì„ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ìƒì„±í•©ë‹ˆë‹¤.

---

### 2. ìœ íš¨ì„± ê²€ì‚¬ 'í‹€(Struct)' ë§Œë“¤ê¸°

`superstruct`ì˜ ê¸°ë³¸ ì‚¬ìš©ë²•ì€, ìš°ë¦¬ê°€ ì˜ˆìƒí•˜ëŠ” ë°ì´í„°ì˜ 'í‹€(struct)'ì„ ë¨¼ì € ì •ì˜í•˜ê³ , ì‹¤ì œ ë“¤ì–´ì˜¨ ë°ì´í„°ê°€ ê·¸ í‹€ì— ë§ëŠ”ì§€ ê²€ì‚¬í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

#### 1\. ìœ ì € ìƒì„±(Create)ì„ ìœ„í•œ Struct ë§Œë“¤ê¸°

ë¨¼ì €, ìœ ì €ë¥¼ ìƒì„±í•  ë•Œ(`POST /users`) í•„ìš”í•œ ë°ì´í„°ì˜ í‹€ì¸ `CreateUser`ë¥¼ ë§Œë“¤ì–´ ë³´ê² ìŠµë‹ˆë‹¤.

```javascript
// /structs.js
import * as s from 'superstruct';
import isEmail from 'is-email';

// CreateUser structë¥¼ ì •ì˜í•˜ê³  export í•©ë‹ˆë‹¤.
export const CreateUser = s.object({
  // email í•„ë“œëŠ” ë‹¨ìˆœí•œ ë¬¸ìì—´ì´ ì•„ë‹Œ, ì‹¤ì œ ì´ë©”ì¼ í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
  email: s.define('Email', isEmail),
  // firstNameê³¼ lastNameì€ 1~30ì ì‚¬ì´ì˜ ë¬¸ìì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
  firstName: s.size(s.string(), 1, 30),
  lastName: s.size(s.string(), 1, 30),
  address: s.string(),
});
```

- **`s.object({ ... })`**: ê°ì²´ í˜•íƒœì˜ í‹€ì„ ì •ì˜í•©ë‹ˆë‹¤.
- **`s.define('Email', isEmail)`**: `is-email` ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´, ë¬¸ìì—´ì´ ì‹¤ì œ ì´ë©”ì¼ í˜•ì‹ì¸ì§€ ê²€ì‚¬í•˜ëŠ” `Email`ì´ë¼ëŠ” ìƒˆë¡œìš´ íƒ€ì…ì„ ì •ì˜í•©ë‹ˆë‹¤.
- **`s.size(s.string(), 1, 30)`**: ë¬¸ìì—´(`s.string()`)ì˜ ê¸¸ì´ê°€ 1 ì´ìƒ 30 ì´í•˜ì¸ì§€ ê²€ì‚¬í•©ë‹ˆë‹¤.

#### 2\. ìœ ì € ìˆ˜ì •(Patch)ì„ ìœ„í•œ Struct ë§Œë“¤ê¸°

ìœ ì € ì •ë³´ë¥¼ ìˆ˜ì •í•  ë•Œ(`PATCH /users/:id`)ëŠ” `email`ì´ë‚˜ `address`ì²˜ëŸ¼ ì¼ë¶€ í•„ë“œë§Œ ìš”ì²­ì— í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë•ŒëŠ” `s.partial()`ì„ ì‚¬ìš©í•´ ê¸°ì¡´ Structì˜ ëª¨ë“  í•„ë“œë¥¼ 'ì„ íƒ ì‚¬í•­'ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```javascript
// /structs.js (CreateUser ì•„ë˜ì— ì¶”ê°€)

// CreateUser structì˜ ëª¨ë“  í•„ë“œë¥¼ ì„ íƒ ì‚¬í•­ìœ¼ë¡œ ë³€ê²½í•œ PatchUserë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
export const PatchUser = s.partial(CreateUser);
```

---

### 3. ë¼ìš°íŠ¸ì— ìœ íš¨ì„± ê²€ì‚¬ ì ìš©í•˜ê¸°

ì´ì œ `app.js`ì˜ `POST`ì™€ `PATCH` ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ ë§¨ ìœ„ì—, `superstruct`ì˜ `assert` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ ìœ íš¨ì„± ê²€ì‚¬ ë¡œì§ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

```javascript
// /app.js
import express from 'express';
import { assert } from 'superstruct';
import { CreateUser, PatchUser } from './structs.js';
// ...

app.post('/users', async (req, res) => {
  // req.bodyê°€ CreateUser structì˜ ê·œì¹™ì„ í†µê³¼í•˜ëŠ”ì§€ ê²€ì‚¬í•©ë‹ˆë‹¤.
  // í†µê³¼í•˜ì§€ ëª»í•˜ë©´ assertê°€ ì—ëŸ¬ë¥¼ ë°œìƒì‹œì¼œ ì•„ë˜ ì½”ë“œëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
  assert(req.body, CreateUser);

  const user = await prisma.user.create({
    data: req.body,
  });
  res.status(201).send(user);
});

app.patch('/users/:id', async (req, res) => {
  // req.bodyê°€ PatchUser structì˜ ê·œì¹™ì„ í†µê³¼í•˜ëŠ”ì§€ ê²€ì‚¬í•©ë‹ˆë‹¤.
  assert(req.body, PatchUser);

  const { id } = req.params;
  const user = await prisma.user.update({
    where: { id },
    data: req.body,
  });
  res.send(user);
});

// ...
```

---

### âœ… í…ŒìŠ¤íŠ¸ ë° ì˜¤ë¥˜ ë¶„ì„

ì´ì œ ë‹¤ì–‘í•œ ì˜ëª»ëœ ìš”ì²­ì„ ë³´ë‚´ `superstruct`ê°€ ì–´ë–»ê²Œ ìš°ë¦¬ì˜ APIë¥¼ ë³´í˜¸í•˜ëŠ”ì§€ í™•ì¸í•´ ë´…ì‹œë‹¤.

#### 1\. ì˜ëª»ëœ ì´ë©”ì¼ í˜•ì‹

`"email": "hyun"`ì²˜ëŸ¼ ì˜ëª»ëœ ì´ë©”ì¼ë¡œ ìš”ì²­ì„ ë³´ë‚´ë©´, `s.define`ìœ¼ë¡œ ë§Œë“¤ì—ˆë˜ `Email` íƒ€ì… ê²€ì‚¬ì— ì‹¤íŒ¨í•©ë‹ˆë‹¤.

> **`StructError`**: At path: email -- Expected a value of type `Email`, but received: `"hyun"`

#### 2\. ë„ˆë¬´ ê¸´ ë¬¸ìì—´

`firstName`ì— 30ìê°€ ë„˜ëŠ” ì•„ì£¼ ê¸´ ì´ë¦„ì„ ë‹´ì•„ ë³´ë‚´ë©´, `s.size` ê²€ì‚¬ì— ì‹¤íŒ¨í•©ë‹ˆë‹¤.

> **`StructError`**: At path: firstName -- Expected a string with a length between `1` and `30` but received one with a length of `84`

> **âš ï¸ `SyntaxError` vs. `StructError`**
> ë§Œì•½ ìš”ì²­ì˜ JSON í˜•ì‹ ìì²´ê°€ ì˜ëª»ë˜ì—ˆë‹¤ë©´(ì˜ˆ: ë”°ì˜´í‘œë¥¼ ë¹¼ë¨¹ê±°ë‚˜ ì—¬ëŸ¬ ì¤„ ë¬¸ìì—´ì„ ì˜ëª» ì‘ì„±), `superstruct`ê°€ ê²€ì‚¬í•˜ê¸°ë„ ì „ì— `body-parser` ë‹¨ê³„ì—ì„œ `SyntaxError`ê°€ ë°œìƒí•©ë‹ˆë‹¤. `SyntaxError`ëŠ” 'ë¬¸ë²•' ì˜¤ë¥˜, `StructError`ëŠ” 'ë°ì´í„° ê·œì¹™' ì˜¤ë¥˜ë¼ê³  ìƒê°í•˜ë©´ ì‰½ìŠµë‹ˆë‹¤.

#### 3\. ìŠ¤í‚¤ë§ˆì— ì—†ëŠ” í•„ë“œ ì¶”ê°€

`age`ì²˜ëŸ¼ `CreateUser`ì— ì •ì˜ë˜ì§€ ì•Šì€ í•„ë“œë¥¼ ì¶”ê°€í•´ì„œ ë³´ë‚´ë©´, `never` íƒ€ì… ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©° ìš”ì²­ì„ ë§‰ì•„ì¤ë‹ˆë‹¤.

> **`StructError`**: At path: age -- Expected a value of type `never`, but received: `20`

#### 4\. ì˜ëª»ëœ ë°ì´í„° íƒ€ì…

`address`ì— ë¬¸ìì—´ì´ ì•„ë‹Œ ìˆ«ìë¥¼ ë³´ë‚´ë©´, `s.string()` íƒ€ì… ê²€ì‚¬ì— ì‹¤íŒ¨í•©ë‹ˆë‹¤.

> **`StructError`**: At path: address -- Expected a string, but received: 123

ì´ì²˜ëŸ¼ `superstruct`ë¥¼ ì‚¬ìš©í•˜ë©´, ë°ì´í„°ê°€ ì‹¤ì œ ë¡œì§ì— ë„ë‹¬í•˜ê¸° ì „ì— ì—¬ëŸ¬ ê·œì¹™ ìœ„ë°˜ ì‚¬ë¡€ë“¤ì„ íš¨ê³¼ì ìœ¼ë¡œ ì°¨ë‹¨í•˜ì—¬ APIì˜ ì•ˆì •ì„±ì„ í¬ê²Œ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

### ğŸ“š ì°¸ê³  ìë£Œ

- **Superstruct ê¸°ë³¸ íƒ€ì…**: [https://docs.superstructjs.org/api-reference/types](https://docs.superstructjs.org/api-reference/types)
- **Superstruct ìƒì„¸ ê·œì¹™ (Refinements)**: [https://docs.superstructjs.org/api-reference/refinements](https://docs.superstructjs.org/api-reference/refinements)
